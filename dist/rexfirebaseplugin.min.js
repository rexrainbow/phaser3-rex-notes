!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).rexfirebaseplugin=t()}(void 0,function(){function a(e){return(a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function A(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,function(e){e=function(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);i=i.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}(e,"string");return"symbol"==typeof e?e:String(e)}(r.key),r)}}function o(e,t,i){t&&A(e.prototype,t),i&&A(e,i),Object.defineProperty(e,"prototype",{writable:!1})}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&Q(e,t)}function u(e){return(u=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function Q(e,t){return(Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e})(e,t)}function T(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");t=e;if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}function h(i){var r=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=u(i);return T(this,r?(e=u(this).constructor,Reflect.construct(t,arguments,e)):t.apply(this,arguments))}}function O(e){return function(e){if(Array.isArray(e))return r(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){var i;if(e)return"string"==typeof e?r(e,t):"Map"===(i="Object"===(i=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:i)||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?r(e,t):void 0}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function r(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function c(e){if("object"===a(e)&&null!==e)if(Array.isArray(e))e.length=0;else for(var t in e)delete e[t]}function S(i,r){return void 0===i&&(i=0),new Promise(function(e,t){setTimeout(function(){e(r)},i)})}function B(e){var t,i;for(i in e)if(e[i]&&(t=me[i])&&!t())return;return 1}function K(s,n){return this.addFile(new ge(this,{config:{callback:function(e,t){return i=n,r="string"==typeof(r=s)?ce(r):le(ce(),r),fe(r.app).then(function(){var e,t,i=[];for(t in r)"app"!==t&&(e=r[t])&&i.push(fe(e));return 0===i.length?Promise.resolve():Promise.all(i)}).then(function(){return de(r)}).then(function(){return void 0!==i&&firebase.initializeApp(i),Promise.resolve()}).then(function(){setTimeout(e,0)}).catch(t);var r,i}}})),this}function l(e){if("object"===a(e)&&!e.nodeType&&e!==e.window){try{if(e.constructor&&!{}.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return}catch(e){return}return 1}}function i(e,t,i,r){if(void 0===r&&(r="."),"object"===a(e)){if(ke(t)){if(null==i)return;"object"===a(i)&&(e=i)}else{r=(t="string"==typeof t?t.split(r):t).pop();(function(e,t,i){var r=e;if(!ke(t))for(var s,n=0,o=(t="string"==typeof t?t.split("."):t).length;n<o;n++)null!=r[s=t[n]]&&"object"===a(r[s])||(r[s]=n!==o-1||void 0===i?{}:i),r=r[s];return r})(e,t)[r]=i}}}function q(e,t){e=d.call(this,e,t),this.updateItemID2Index(),this.emit(this.eventNameMap.add,e),this.emit(this.eventNameMap.update,this.items)}function t(e,t){var i=H.call(this,e),e=(this.updateItemID2Index(),d.call(this,e,t));this.updateItemID2Index(),this.emit(this.eventNameMap.change,e,i),this.emit(this.eventNameMap.update,this.items)}function z(e){e=H.call(this,e),this.updateItemID2Index(),this.emit(this.eventNameMap.remove,e),this.emit(this.eventNameMap.update,this.items)}function f(e){this.clear(),e.forEach(function(e){d.call(this,e,null,!0)}.bind(this)),this.updateItemID2Index(),this.emit(this.eventNameMap.update,this.items)}function d(e,t,i){var r=this.getItemCallback,s=(s=this.getItemCallbackScope)?r.call(s,e):r(e);return i?this.items.push(s):null==t?this.items.unshift(s):(r=this.itemID2Index[t])===this.items.length-1?this.items.push(s):this.items.splice(r+1,0,s),s}function H(e){return e=this.itemID2Index[e.key],Re(this.items,e)}function V(e,t){var i=!1;return e.forEach(function(e){if(e.val().userID===t)return i=!0}),i}function W(e){var t,i,r;if(null==e||"object"!==a(e))return e;if(t=Array.isArray(e)?[]:{},l(e))for(r in e)i=e[r],t[r]=W(i);else t=e;return t}function Y(e){return this.getRoomAliveRef(e).transaction(function(e){if(null===e)return!0})}function G(r){var s=(r=le(Te,r)).roomID,e=r.roomName,t=r.roomType,i=r.door,n=r.join,o=r.filterData,a=this.getRoomRef(s),u=this.getRoomFilterRef(s),h=this.getRoomDataRef(s),a=(this.isRemoveRoomWhenLeft=!r.presisted,this.isRemoveRoomWhenLeft&&(a.onDisconnect().remove(),u.onDisconnect().remove(),h.onDisconnect().remove()),x(i,t)),c={},u={filter:a,name:e};o&&(u.data=o),c["room-filters/".concat(s)]=u;(h={name:e,filter:a,maxUsers:r.maxUsers,moderators:{}}).moderators[this.userID]=this.userName,c["room-data/".concat(s)]=h;var l=this;return new Promise(function(e,t){var i;return n?(i=l.userList.setRootPath(l.getUserListPath(s)).setMaxUsers(0).join(),l.userList.setMaxUsers(r.maxUsers),i.then(e,t)):e()}).then(function(){return l.getRootRef().update(c)}).then(function(){return l.isRoomCreator=!0,n&&Qe.call(l,r),Promise.resolve(r)})}function J(e,t,i,r){if(r.roomID=N(e,e,t),i<=0)return Promise.reject(r);i--;var s=this;return this.createRoom(r).catch(function(){return J.call(s,e,t,i,r)})}function X(t){if(void 0===y(t,"roomID",void 0))return Promise.reject();this.isRemoveRoomWhenLeft=!1;var i=this;return Ke.call(i,t).then(function(e){return i.userList.setRootPath(i.getUserListPath(t.roomID)).setMaxUsers(e.maxUsers).join()}).then(function(){return Qe.call(i,t),Promise.resolve(t)})}function Z(e,t,i){if(i===t.length)return Promise.reject();e.roomID=t[i].roomID,i++;var r=this;return this.joinRoom(e).catch(function(){return Z.call(r,e,t,i)})}function $(r){var e=r.query,s=(r.startDocRef&&(e=e[r.startMode](r.startDocRef)),Math.min(r.remainderLines,r.linesPerPage));return r.remainderLines-=s,e.limit(s).get().then(function(e){var t,i=0===r.remainderLines||e.size<s;return r.forEachPageCallback&&(i|=!!r.forEachPageCallback(e)),i?(r.resolveCallback&&(t=r.resolveCallback()),Promise.resolve(t)):(r.startDocRef=e.docs[e.size-1],r.startMode="startAfter",$(r))})}function ee(){var i=this;return L(this.nextQuery,this.itemCount,0,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return i.cacheItems=e,i.pageIndex=0,i.startItemIndex=0,i.endItemIndex=i.startItemIndex+t-1,i.isFullPage=t===i.itemCount,i.prevPageEndDocRef=void 0,i.currPageStartDocRef=e[0],i.currPageEndDocRef=e[t-1],Promise.resolve(i.cacheItems)})}function te(){var i=this;return L(this.nextQuery,this.itemCount,0,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return i.cacheItems=e,i.pageIndex=0,i.startItemIndex=0,i.endItemIndex=i.startItemIndex+t-1,i.isFullPage=t===i.itemCount,Promise.resolve(i.cacheItems)})}function ie(){var i=this;return L(this.nextQuery,this.itemCount,0,this.currPageEndDocRef,"startAfter").then(function(e){var t=e.length;return i.cacheItems=e,i.pageIndex+=1,i.startItemIndex=i.endItemIndex+1,i.endItemIndex=i.startItemIndex+t-1,i.isFullPage=t===i.itemCount,i.prevPageEndDocRef=i.currPageEndDocRef,i.currPageStartDocRef=e[0],i.currPageEndDocRef=e[t-1],Promise.resolve(i.cacheItems)})}function re(){var e=(this.pageIndex+1)*this.itemCount,i=this;return L(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return i.cacheItems=e,i.pageIndex+=1,i.startItemIndex=i.endItemIndex+1,i.endItemIndex=i.startItemIndex+t-1,i.isFullPage=t===i.itemCount,Promise.resolve(i.cacheItems)})}function se(){var i=this;return L(this.prevQuery,this.itemCount+1,0,this.currPageStartDocRef,"startAfter").then(function(e){var t=e.length-1;return i.cacheItems=e,i.cacheItems.pop(),i.cacheItems.reverse(),--i.pageIndex,i.endItemIndex=i.startItemIndex-1,i.startItemIndex=i.endItemIndex-t+1,i.isFullPage=t===i.itemCount,i.prevPageEndDocRef=e[t],i.currPageStartDocRef=e[t-1],i.currPageEndDocRef=e[0],Promise.resolve(i.cacheItems)})}function ne(){var e=(this.pageIndex-1)*this.itemCount,i=this;return L(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return i.cacheItems=e,--i.pageIndex,i.endItemIndex=i.startItemIndex-1,i.startItemIndex=i.endItemIndex-t+1,i.isFullPage=t===i.itemCount,Promise.resolve(i.cacheItems)})}function oe(){var i=this;return L(this.nextQuery,this.itemCount,0,this.prevPageEndDocRef,"startAfter").then(function(e){var t=e.length;return i.cacheItems=e,i.endItemIndex=i.startItemIndex+t-1,i.isFullPage=t===i.itemCount,i.currPageStartDocRef=e[0],i.currPageEndDocRef=e[t-1],Promise.resolve(i.cacheItems)})}function ae(){var e=this.pageIndex*this.itemCount,i=this;return L(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return i.cacheItems=e,i.endItemIndex=i.startItemIndex+t-1,i.isFullPage=t===i.itemCount,Promise.resolve(i.cacheItems)})}function m(e,t,i,r){var s=N(t,t,i);if(r<=0)return Promise.reject({id:e,alias:s});r--;var n=this;return Ge.call(n,e,s).catch(function(){setTimeout(function(){return m.call(n,e,t,i,r)},0)})}function ue(e){var t=(e=e?new Date(e):new Date).getFullYear(),i=e.getMonth()+1,r=e.getDate(),s=new Date(e.getFullYear(),0,1),e=Math.ceil(((e-s)/864e5+s.getDay()+1)/7);return{d:"".concat(t,"-").concat(i,"-").concat(r),w:"".concat(t,"-").concat(e),m:"".concat(t,"-").concat(i),y:"".concat(t),a:""}}function he(e){return L(e).then(function(e){if(0===e.length)return Promise.resolve();for(var t,i,r=[],s=0,n=e.length;s<n;s++)void 0===t&&(t=firebase.firestore().batch(),i=0),t.delete(e[s].ref),500<=++i&&(r.push(t.commit()),t=void 0);return t&&r.push(t.commit()),Promise.all(r)})}var ce=function(e){return{app:"https://www.gstatic.com/firebasejs/".concat(e=void 0===e?"7.19.0":e,"/firebase-app.js"),database:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-database.js"),firestore:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-firestore.js")}},le=function(e,t){var i,r=function(e,t){var i=Array.isArray(e);if(void 0===t?t=i?[]:{}:c(t),i){t.length=e.length;for(var r=0,s=e.length;r<s;r++)t[r]=e[r]}else for(var n in e)t[n]=e[n];return t}(e);for(i in t)r.hasOwnProperty(i)&&(r[i]=t[i]);return r},fe=function(a){return new Promise(function(e,t){for(var i=a,r=e,s=document.getElementsByTagName("script"),n=0,o=s.length;n<o;n++)if(-1!=s[n].src.indexOf(i))return void(r&&r());e=document.createElement("script");e.setAttribute("src",i),r&&(e.onload=r),document.head.appendChild(e)})},de=function e(t){return B(t)?Promise.resolve():S(10).then(function(){return e(t)})},me={database:function(){return void 0!==firebase.database},firestore:function(){return void 0!==firebase.firestore}},ve=Phaser.Loader.FILE_POPULATED,ye=Phaser.Utils.String.UUID,ge=function(){s(r,Phaser.Loader.File);var i=h(r);function r(e,t){return n(this,r),t.hasOwnProperty("type")||(t.type="await"),t.hasOwnProperty("url")||(t.url=""),t.hasOwnProperty("key")||(t.key=ye()),i.call(this,e,t)}return o(r,[{key:"load",value:function(){var e,t,i,r;this.state===ve?this.loader.nextFile(this,!0):(e=(t=this.config).callback,t=t.scope,i=this.onLoad.bind(this),r=this.onError.bind(this),e?t?e.call(t,i,r):e(i,r):this.onLoad())}},{key:"onLoad",value:function(){this.loader.nextFile(this,!0)}},{key:"onError",value:function(){this.loader.nextFile(this,!1)}}]),r}(),v=function(){function i(){n(this,i)}return o(i,[{key:"initializeApp",value:function(e){return firebase.initializeApp(e),this}}],[{key:"register",value:function(e,t){i.prototype[e]=t}}]),i}(),e={setEventEmitter:function(e,t){return void 0===t&&(t=Phaser.Events.EventEmitter),this._privateEE=!0===e||void 0===e,this._eventEmitter=this._privateEE?new t:e,this},destroyEventEmitter:function(){return this._eventEmitter&&this._privateEE&&this._eventEmitter.shutdown(),this},getEventEmitter:function(){return this._eventEmitter},on:function(){return this._eventEmitter&&this._eventEmitter.on.apply(this._eventEmitter,arguments),this},once:function(){return this._eventEmitter&&this._eventEmitter.once.apply(this._eventEmitter,arguments),this},off:function(){return this._eventEmitter&&this._eventEmitter.off.apply(this._eventEmitter,arguments),this},emit:function(e){return this._eventEmitter&&e&&this._eventEmitter.emit.apply(this._eventEmitter,arguments),this},addListener:function(){return this._eventEmitter&&this._eventEmitter.addListener.apply(this._eventEmitter,arguments),this},removeListener:function(){return this._eventEmitter&&this._eventEmitter.removeListener.apply(this._eventEmitter,arguments),this},removeAllListeners:function(){return this._eventEmitter&&this._eventEmitter.removeAllListeners.apply(this._eventEmitter,arguments),this},listenerCount:function(){return this._eventEmitter?this._eventEmitter.listenerCount.apply(this._eventEmitter,arguments):0},listeners:function(){return this._eventEmitter?this._eventEmitter.listeners.apply(this._eventEmitter,arguments):[]},eventNames:function(){return this._eventEmitter?this._eventEmitter.eventNames.apply(this._eventEmitter,arguments):[]}},y=function(e,t,i){if(e&&"number"!=typeof e){if(e.hasOwnProperty(t))return e[t];if(-1===t.indexOf("."))return i;for(var r=t.split("."),s=e,n=i,o=0;o<r.length;o++){if(!s.hasOwnProperty(r[o])){n=i;break}n=s[r[o]],s=s[r[o]]}return n}return i},g={startReceiving:function(){return this.isReceiving&&this.receiverRef.key===this.receiverID||(this.stopReceiving(),this.isReceiving=!0,this.skipFirst=!0,this.receiverRef=this.database.ref(this.rootPath).child(this.receiverID),this.receiverRef.on("value",pe,this),this.receiverRef.onDisconnect().remove()),this},stopReceiving:function(){return this.isReceiving&&(this.isReceiving=!1,this.receiverRef.off("value",pe,this),this.receiverRef.remove(),this.receiverRef.onDisconnect().cancel()),this}},pe=function(e){this.skipFirst?this.skipFirst=!1:null!=(e=e.val())&&(delete e.stamp,this.history.add(e),this.emit(this.eventNameMap.receive,e))},Ie=function(){function t(e){n(this,t),this.maxLength=y(e,"maxLength",-1),this.records=[]}return o(t,[{key:"add",value:function(e){return 0!==this.maxLength&&(this.records.push(e),0<this.maxLength&&this.records.length>this.maxLength)&&this.records.shift(),this}},{key:"clear",value:function(){return this.records.length=0,this}},{key:"changeUserName",value:function(t,i){return 0!==this.maxLength&&this.records.forEach(function(e){e.senderID===t&&(e.senderName=i)}),this}}]),t}(),p=function(){function r(e){n(this,r);var t=y(e,"eventEmitter",void 0),i=y(e,"EventEmitterClass",void 0),t=(this.setEventEmitter(t,i),this.eventNameMap=y(e,"eventNames",De),this.database=firebase.database(),this.setRootPath(y(e,"root","")),this.skipFirst=!0,this.stamp=!1,this.userInfo={userID:"",userName:void 0},this.setSender(y(e,"senderID",""),y(e,"senderName","")),this.setReceiver(y(e,"receiverID","")),this.isReceiving=!1,y(e,"history",0));!0===t?t=-1:!1===t&&(t=0),this.history=new Ie({maxLength:t})}return o(r,[{key:"shutdown",value:function(){this.stopReceiving().destroyEventEmitter()}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.sendToRef=void 0,this.receiverRef=void 0,this}},{key:"setSender",value:function(e,t){return l(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setReceiver",value:function(e){return this.receiverID=e,this}},{key:"changeUserName",value:function(e,t){return e===this.userID&&(this.userName=t),this.history.changeUserName(e,t),this}},{key:"getHistory",value:function(){return this.history.records}},{key:"clearHistory",value:function(){return this.history.clear(),this}}]),r}(),De=(Object.assign(p.prototype,e,g,{send:function(e){return this.sendToRef&&this.sendToRef.key===this.receiverID||(this.sendToRef=this.database.ref(this.rootPath).child(this.receiverID)),void 0===e?this.sendToRef.remove():(e={message:e,senderID:this.userID,stamp:this.stamp},void 0!==this.userName&&(e.senderName=this.userName),this.skipFirst=!1,this.stamp=!this.stamp,this.sendToRef.set(e))}}),{receive:"receive"}),ke=function(e){return null==e||""===e||0===e.length},g=(v.register("broadcast",function(e){return new p(e)}),i(window,"RexPlugins.Fire.Broadcast",p),{clear:function(){return this.items.length=0,c(this.itemID2Index),this},getItems:function(){return this.items},hasItem:function(e){return this.itemID2Index.hasOwnProperty(e)},getItemIndexFromItemID:function(e){return null==e?null:this.itemID2Index[e]},getItemFromItemID:function(e){return null==e||null==(e=this.getItemIndexFromItemID(e))?null:this.items[e]},forEach:function(e,t){return this.items.forEach(e,t),this},updateItemID2Index:function(){var e;c(this.itemID2Index);for(var t=0,i=this.items.length;t<i;t++)e=this.items[t][this.keyItemID],this.itemID2Index[e]=t;return this}}),Re=function(e,t){if(!(t>=e.length)){for(var i=e.length-1,r=e[t],s=t;s<i;s++)e[s]=e[s+1];return e.length=i,r}},I={start:function(e){return this.isUpdating=!1,e.once("value",f,this),this},stop:function(){return this}},D={start:function(e){return e.on("child_added",q,this),e.on("child_removed",z,this),e.on("child_moved",t,this),e.on("child_changed",t,this),this},stop:function(){return this.query.off("child_added",q,this),this.query.off("child_removed",z,this),this.query.off("child_moved",t,this),this.query.off("child_changed",t,this),this}},Pe={start:function(e){return e.on("value",f,this),this},stop:function(){return this.query.off("value",f,this),this}},k=function(){function r(e){n(this,r);var t=y(e,"eventEmitter",void 0),i=y(e,"EventEmitterClass",void 0);this.setEventEmitter(t,i),this.eventNameMap=y(e,"eventNames",Ee),this.isUpdating=!1,this.items=[],this.itemID2Index={},this.setItemIDKey(y(e,"itemIDKey","__itemID__")),this.setMode(y(e,"mode",1)),this.setGetitemCallback(y(e,"getItemCallback",be),y(e,"getItemCallbackScope",this)),this.setQuery(y(e,"query",void 0))}return o(r,[{key:"shutdown",value:function(){this.stopUpdate().clear()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setItemIDKey",value:function(e){return this.keyItemID=e,this}},{key:"setMode",value:function(e){return"string"==typeof e&&(e=xe[e]),this.mode=e,this.updater=we[e],this}},{key:"setGetitemCallback",value:function(e,t){return this.getItemCallback=e,this.getItemCallbackScope=t,this}},{key:"setQuery",value:function(e){return this.query=e,this}},{key:"startUpdate",value:function(e){if(e)this.setQuery(e);else{if(!this.query)return this;e=this.query}return this.stopUpdate().clear(),this.isUpdating=!0,this.updater.start.call(this,e),this}},{key:"stopUpdate",value:function(){return this.query&&this.isUpdating&&(this.isUpdating=!1,this.updater.stop.call(this)),this}}]),r}(),be=function(e){var t=e.val();return t[this.keyItemID]=e.key,t},Ee=(Object.assign(k.prototype,e,g),{update:"update",add:"add",remove:"remove",change:"change"}),we={0:I,1:D,2:Pe},xe={once:0,child:1,all:2},R=function(){function r(e){n(this,r);var t=y(e,"eventEmitter",void 0),i=y(e,"EventEmitterClass",void 0);this.setEventEmitter(t,i),this.database=firebase.database(),this.setRootPath(y(e,"root","")),this.userInfo={userID:"",userName:""},this.setUser(y(e,"userID",""),y(e,"userName","")),this.setMaxUsers(y(e,"maxUsers",0)),this.userList=new k({eventEmitter:this.getEventEmitter(),itemIDKey:"joinAt",eventNames:{add:y(e,"eventNames.join","join"),remove:y(e,"eventNames.leave","leave"),update:y(e,"eventNames.update","update"),change:y(e,"eventNames.change","change"),init:y(e,"eventNames.init","init"),changename:y(e,"eventNames.changename","changename")}}),this.isInList=!1,this.userID2ItemID={},this.userList.on(this.userList.eventNames.add,function(e){this.userID2ItemID[e.userID]=e.joinAt,e.userID===this.userInfo.userID&&this.emit(this.userList.eventNames.init,this.getUsers())},this).on(this.userList.eventNames.remove,function(e){delete this.userID2ItemID[e.userID],e.userID===this.userID&&(this.isInList=!1)},this).on(this.userList.eventNames.change,function(e,t){var i=e.userID,e=e.userName,t=t.userName;e!==t&&this.emit(this.userList.eventNames.changename,i,e,t)},this)}return o(r,[{key:"shutdown",value:function(){this.stopUpdate().destroyEventEmitter().leave(),this.userList.shutdown()}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"setRootPath",value:function(e){return this.rootPath=e,this}},{key:"rootRef",get:function(){return this.database.ref(this.rootPath)}},{key:"setUser",value:function(e,t){return l(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setMaxUsers",value:function(e){return this.maxUsers=e,this}},{key:"clear",value:function(){return this.userList.clear(),this}},{key:"forEach",value:function(e,t){return this.userList.forEach(e,t),this}},{key:"isFull",value:function(){return 0!==this.maxUsers&&this.userList.getItems().length>=this.maxUsers}},{key:"isFirstUser",value:function(e){void 0===e&&(e=this.userID);var t=this.usersList.getItems()[0];return t&&t.userID===e}},{key:"getUser",value:function(e){return void 0===e&&(e=this.userID),this.contains(e)?(e=this.userID2ItemID[e],this.userList.getItemFromItemID(e)):null}},{key:"getUsers",value:function(){return this.userList.getItems()}},{key:"getUserRef",value:function(e){return void 0===e&&(e=this.userID),this.contains(e)?(e=this.userID2ItemID[e],this.rootRef.child(e)):null}},{key:"contains",value:function(e){return void 0===e&&(e=this.userID),this.userID2ItemID.hasOwnProperty(e)}},{key:"startUpdate",value:function(){var e=this.database.ref(this.rootPath);return 0<this.maxUsers&&(e=e.limitToFirst(this.maxUsers)),this.userList.startUpdate(e),this}},{key:"stopUpdate",value:function(){return this.userList.stopUpdate(),this}}]),r}(),Ne=(Object.assign(R.prototype,e,{join:function(t,e){var i,r,s,n;return void 0===t&&(t=this.userID,e=this.userName),this.contains(t)?Promise.resolve():(i={userID:t,userName:e},r=this.maxUsers,s=this.database.ref(this.rootPath),(n=s.push()).onDisconnect().remove().then(function(){return n.set(i)}).then(function(){return S(0)}).then(function(){return 0===r?(self.isInList=!0,Promise.resolve()):s.limitToFirst(r).once("value").then(function(e){return V(e,t)?(self.isInList=!0,Promise.resolve()):(self.isInList=!1,n.remove().then(function(){return n.onDisconnect().cancel()}).then(function(){return Promise.reject()}))})}))},leave:function(e){return void 0===e&&(e=this.userID),this.contains(e)?(e=this.userID2ItemID[e],this.database.ref(this.rootPath).child(e).remove()):Promise.resolve()},changeUserName:function(t){var r=this;return new Promise(function(t,e){var i=r.getUserRef();i?t(i):r.rootRef.orderByChild("userID").equalTo(r.userID).once("child_added").then(function(e){t(e.ref)})}).then(function(e){return e.child("userName").set(t)}).then(function(){return r.userName=t,Promise.resolve()})}}),v.register("onlineUserList",function(e){return new R(e)}),i(window,"RexPlugins.Fire.OnlineUserList",R),function(){this.emit("room.leave");var e=this;setTimeout(function(){e.roomID=void 0,e.roomName=void 0,e.doorState=void 0,e.leftRoomFlag=!1},0)}),Fe=function(){function t(e){n(this,t),this.data=e=void 0===e?{}:e,this.refPath=""}return o(t,[{key:"getFullPath",value:function(e){var t;return"string"==typeof e&&("."===e?e=this.refPath:e.startsWith("..")?e=""!==this.refPath?((t=this.refPath.split(".")).pop(),"".concat(t.join(".")).concat(e.substring(1))):e.substring(2):e.startsWith(".")&&(e=""!==this.refPath?"".concat(this.refPath).concat(e):e.substring(1))),e}},{key:"setRefPath",value:function(e){return this.refPath=this.getFullPath(e=void 0===e?"":e),this}},{key:"setValue",value:function(e,t){return void 0===e?this.clear():void 0===t?this.data=e:i(this.data,this.getFullPath(e),t),this}},{key:"getValue",value:function(e){return void 0===e?this.data:("string"==typeof e&&(e=this.getFullPath(e).split(".")),b(this.data,e))}},{key:"cloneValue",value:function(e){return W(this.getValue(e))}},{key:"removeKey",value:function(e){var t;return void 0===e?this.clear():(t=(e="string"==typeof e?this.getFullPath(e).split("."):e).pop(),e=b(this.data,e),P(e)&&delete e[t]),this}},{key:"hasKey",value:function(e){var t=(e="string"==typeof e?this.getFullPath(e).split("."):e).pop(),e=b(this.data,e);return!!P(e)&&e.hasOwnProperty(t)}},{key:"clear",value:function(){return c(this.data),this}},{key:"clone",value:function(e){e=new t(e?this.cloneValue():this.data);return e.setRefPath(this.refPath),e}}]),t}(),P=function(e){return null!=e&&"object"===a(e)},b=function(e,t){if(""===t[0])return e;for(var i=e,r=0,s=t.length;r<s;r++){if(!P(i))return;i=i[t[r]]}return i},E=function(){function s(e){n(this,s),this.setEventEmitter(e.eventEmitter,e.EventEmitterClass),this.parent=e.parent,this.key=e.key,this.parent?this.fullKeyPath=Ue(this.parent.fullKeyPath,this.key):this.fullKeyPath="",this.type=e.type,this.eventNameMap=e.eventNames,this.table=e.table,this.database=firebase.database(),this.setRootPath(),this.children={}}return o(s,[{key:"shutdown",value:function(){this.stopUpdate().clear().destroyEventEmitter()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){var t,i,r;for(r in void 0===e&&(t=this.parent?this.parent.rootPath:"",e="".concat(t,"/").concat(this.key)),this.rootPath=e,this.children)(i=this.children[r])instanceof s&&i.setRootPath();return this}},{key:"rootRef",get:function(){return this.database.ref(this.rootPath)}},{key:"load",value:function(){var t=this;return this.rootRef.once("value").then(function(e){e=e.val()||{};return t.table.setValue(e),Promise.resolve(e)})}},{key:"setData",value:function(e,t){if(void 0===e)this.clear();else if(void 0===t){var i=e;for(e in this.children)i.hasOwnProperty(e)||this.removeChild(e);for(e in i)this.setChildData(e,i[e])}else this.setChildData(e,t);return this}},{key:"clear",value:function(){for(var e in this.table.removeKey(this.fullKeyPath),this.children)this.removeChild(e);return this}},{key:"childClass",get:function(){}},{key:"setChildData",value:function(e,t){var i=Ue(this.fullKeyPath,e);return this.table.setValue(i,t),this.children.hasOwnProperty(e)?this.children[e].setData(t):this.childClass&&((i=new this.childClass({parent:this,key:e,type:this.type,eventEmitter:this.getEventEmitter(),eventNames:this.eventNameMap,table:this.table})).startUpdate(),this.children[e]=i),this}},{key:"removeChild",value:function(e){return this.children.hasOwnProperty(e)&&(this.children[e].destroy(),delete this.children[e]),this}},{key:"startUpdate",value:function(){}},{key:"stopUpdate",value:function(){}}]),s}(),Ue=function(e,t){return null==e||""===e?t:null==t||""===t?e:"".concat(e,".").concat(t)},Le=(Object.assign(E.prototype,e),function(){s(t,E);var e=h(t);function t(){return n(this,t),e.apply(this,arguments)}return o(t,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addCol,this),this.rootRef.on("child_removed",this.removeCol,this),this.rootRef.on("child_changed",this.changeColValue,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addCol,this),this.rootRef.off("child_removed",this.removeCol,this),this.rootRef.off("child_changed",this.changeColValue,this),this}},{key:"addCol",value:function(e){var t=e.key,i=e.val();switch(this.setData(t,i),this.type){case 1:this.emit(this.eventNameMap.addkey0,t,i);break;case 2:this.emit(this.eventNameMap.addkey1,this.key,t,i);break;default:this.emit(this.eventNameMap.addkey2,this.pageKey,this.key,t,i)}this.emit(this.eventNameMap.update,this.table.data)}},{key:"removeCol",value:function(e){var t=e.key;switch(this.removeChild(t),this.type){case 1:this.emit(this.eventNameMap.removekey0,t);break;case 2:this.emit(this.eventNameMap.removekey1,this.key,t);break;default:this.emit(this.eventNameMap.removekey2,this.pageKey,this.key,t)}this.emit(this.eventNameMap.update,this.table.data)}},{key:"changeColValue",value:function(e){var t=e.key,i=e.val();switch(this.setData(t,i),this.type){case 1:this.emit(this.eventNameMap.changekey0,t,i);break;case 2:this.emit(this.eventNameMap.changekey1,this.key,t,i);break;default:this.emit(this.eventNameMap.changekey2,this.pageKey,this.key,t,i)}this.emit(this.eventNameMap.update,this.table.data)}},{key:"pageKey",get:function(){return this.parent.key}}]),t}()),Ce=function(){s(t,E);var e=h(t);function t(){return n(this,t),e.apply(this,arguments)}return o(t,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addRow,this),this.rootRef.on("child_removed",this.removeRow,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addRow,this),this.rootRef.off("child_removed",this.removeRow,this),this}},{key:"addRow",value:function(e){var t=e.key,e=e.val();this.setData(t,e),2===this.type?this.emit(this.eventNameMap.addkey0,this.key,t,e):this.emit(this.eventNameMap.addkey1,this.key,t,e)}},{key:"removeRow",value:function(e){e=e.key;this.removeChild(e),2===this.type?this.emit(this.eventNameMap.removekey0,e):this.emit(this.eventNameMap.removekey1,this.key,e)}},{key:"childClass",get:function(){return Le}},{key:"pageKey",get:function(){return this.parent.key}}]),t}(),g=function(){s(i,E);var t=h(i);function i(e){return n(this,i),t.call(this,e)}return o(i,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addPage,this),this.rootRef.on("child_removed",this.removePage,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addPage,this),this.rootRef.off("child_removed",this.removePage,this),this}},{key:"addPage",value:function(e){var t=e.key,e=e.val();this.setData(t,e),this.emit(this.eventNameMap.addkey0,t,e)}},{key:"removePage",value:function(e){e=e.key;this.removeChild(e),this.emit(this.eventNameMap.removekey0,e)}},{key:"childClass",get:function(){return Ce}}]),i}(),w=function(){function r(e){n(this,r);var t=y(e,"eventEmitter",void 0),i=y(e,"EventEmitterClass",void 0);this.setEventEmitter(t,i),this.eventNameMap=y(e,"eventNames",_e),this.database=firebase.database(),this.table=new Fe,this.setTableType(y(e,"type",3)),this.setRootPath(y(e,"root","")),this.initialFlag=!1}return o(r,[{key:"shutdown",value:function(){this.updater.destroy(),this.destroyEventEmitter().stopUpdate()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.updater.setRootPath(e),this}},{key:"setTableType",value:function(e){"string"==typeof e&&(e=Me[e]),this.tableType=e;var t=je[e];return this.updater=new t({type:e,eventEmitter:this.getEventEmitter(),eventNames:this.eventNameMap,table:this.table}),this}},{key:"getRootRef",value:function(){return this.database.ref(this.rootPath)}},{key:"getRef",value:function(e,t,i){var r=this.getRootRef(),r=e?r.child(e):r;return r=t?r.child(t):r,r=i?r.child(i):r}},{key:"startUpdate",value:function(){return function(){var t=this;return this.initialFlag=!1,this.updater.clear().load().then(function(e){return t.initialFlag=!0,t.emit(t.eventNames.init,e),Promise.resolve(e)})}.call(this),this.updater.startUpdate(),this}},{key:"stopUpdate",value:function(){return this.updater.stopUpdate(),this}},{key:"clear",value:function(){return this.updater.clear(),this}},{key:"getData",value:function(){return this.table.getValue(arguments)}},{key:"cloneData",value:function(){return this.table.cloneValue(arguments)}}]),r}(),je={1:Le,2:Ce,3:g},Me=(Object.assign(w.prototype,e,{setData:function(){switch(arguments.length){case 4:var e=Array.prototype.slice.call(arguments),t=e[0],i=e[1],r=e[2],s=e[3];break;case 3:e=Array.prototype.slice.call(arguments);t=e[0],i=e[1],s=e[2];break;case 2:e=Array.prototype.slice.call(arguments);t=e[0],s=e[1];break;default:s=arguments[0]}return this.getRef(t,i,r).set(s)},removeData:function(){switch(arguments.length){case 3:var e=Array.prototype.slice.call(arguments),t=e[0],i=e[1],r=e[2];break;case 2:e=Array.prototype.slice.call(arguments);t=e[0],i=e[1];break;default:t=arguments[0]}return this.getRef(t,i,r).remove()},incValue:function(){switch(arguments.length){case 4:var e=Array.prototype.slice.call(arguments),t=e[0],i=e[1],r=e[2],s=e[3];break;case 3:e=Array.prototype.slice.call(arguments);t=e[0],i=e[1],s=e[2];break;case 2:e=Array.prototype.slice.call(arguments);t=e[0],s=e[1];break;default:s=arguments[0]}return this.getRef(t,i,r).transaction(function(e){return(e=null===e?0:e)+s})},transaction:function(){switch(arguments.length){case 4:var e=Array.prototype.slice.call(arguments),t=e[0],i=e[1],r=e[2],s=e[3];break;case 3:e=Array.prototype.slice.call(arguments);t=e[0],i=e[1],s=e[2];break;case 2:e=Array.prototype.slice.call(arguments);t=e[0],s=e[1];break;default:s=arguments[0]}return this.getRef(t,i,r).transaction(s)},updateData:function(e){return this.getRef().update(e)},removeDataOnDisconnect:function(){switch(arguments.length){case 3:var e=Array.prototype.slice.call(arguments),t=e[0],i=e[1],r=e[2];break;case 2:e=Array.prototype.slice.call(arguments);t=e[0],i=e[1];break;case 1:t=arguments[0]}return this.getRef(t,i,r).onDisconnect().remove()},setDataOnDisconnect:function(){switch(arguments.length){case 4:var e=Array.prototype.slice.call(arguments),t=e[0],i=e[1],r=e[2],s=e[3];break;case 3:e=Array.prototype.slice.call(arguments);t=e[0],i=e[1],s=e[2];break;case 2:e=Array.prototype.slice.call(arguments);t=e[0],s=e[1];break;default:s=arguments[0]}return this.getRef(t,i,r).onDisconnect().set(s)}}),{"1d":1,"2d":2,"3d":3}),_e={init:"init",update:"update",addkey0:"addkey0",removekey0:"removekey0",changekey0:"changekey0",addkey1:"addkey1",removekey1:"removekey1",changekey1:"changekey1",addkey2:"addkey2",removekey2:"removekey2",changekey2:"changekey2"},Ae=function(e){var t=e.key,i=new w({eventEmitter:this.getEventEmitter(),root:this.getItemTablePath(this.roomID,t),type:y(e,"type",1),eventNames:{init:"tables.".concat(t,".init"),update:"tables.".concat(t,".update"),addkey0:"tables.".concat(t,".addkey0"),removekey0:"tables.".concat(t,".removekey0"),changekey0:"tables.".concat(t,".changekey0"),addkey1:"tables.".concat(t,".addkey1"),removekey1:"tables.".concat(t,".removekey1"),changekey1:"tables.".concat(t,".changekey1"),addkey2:"tables.".concat(t,".addkey2"),removekey2:"tables.".concat(t,".removekey2"),changekey2:"tables.".concat(t,".changekey2")}});return this.on("room.join",function(){i.startUpdate()}).on("room.leave",function(){i.clear().stopUpdate()}),i},x=function(e,t){return void 0===t&&(t=""),"".concat(e,"|").concat(t)},Qe=function(e){this.roomID=e.roomID,this.roomName=e.roomName,this.roomType=e.roomType,this.emit("room.join",e)},Te={roomID:"",roomName:"",roomType:"",maxUsers:0,presisted:!1,door:"open",join:!0,filterData:void 0},Oe=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},Se=function(e,t,i){void 0===i&&(i=e.length);t=(t=void 0===t?0:t)+Math.floor(Math.random()*i);return void 0===e[t]?null:e[t]},Be="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",N=function(e,t,i){void 0===i&&(i=Be);for(var r=void 0===t?e:Oe(e,t),s="",n=0;n<r;n++)s+=Se(i);return s},Ke=function(t){var i=this;return this.getRoomDataRef(t.roomID).once("value").then(function(e){e=e.val();return null!==e&&(t.roomName=e.name,t.roomType=e.filter.split("|")[1],i.isRoomOpened(e))?Promise.resolve(e):Promise.reject()})},I={createRoom:function(e){null==(e=void 0===e?{}:e).roomID&&(e.roomID=this.getRoomRef().push().key);var t=this;return Y.call(t,e.roomID).then(function(){return G.call(t,e)})},createRandomRoom:function(e){var t=y(e=void 0===e?{}:e,"digits",10),i=y(e,"candidates","0123456789"),r=y(e,"retry",1e3);return J.call(this,t,i,r,e)},joinRoom:function(e){var t=y(e,"leftThenJoin",!0),i=this;return t?this.leaveRoom().then(function(){return X.call(i,e)}):X.call(i,e)},joinRandomRoom:function(n){var e=y(n=void 0===n?{}:n,"roomType",""),t=y(n,"door","open"),o=this;return this.getRoomList(e,t).then(function(e){for(var t=e,i=t.length-1;0<i;i--){var r=Math.floor(Math.random()*(i+1)),s=t[i];t[i]=t[r],t[r]=s}return Z.call(o,n,e,0)})},leaveRoom:function(){var e;return this.isInRoom()?(this.leftRoomFlag=!0,this.isRemoveRoomWhenLeft?this.removeRoom():(e=this.getRoomInfo(),this.userList.leave().then(function(){return Promise.resolve(e)}))):Promise.resolve()},removeRoom:function(e){var t,i;return void 0===(e=void 0===e?this.roomID:e)?Promise.resolve():((t={})["room-filter/".concat(e)]=null,t["room-data/".concat(e)]=null,t["rooms/".concat(e)]=null,i=this.getRoomInfo(),this.getRootRef().update(t).then(function(){return Promise.resolve(i)}))},kickUser:function(e){return this.userList.contains(e)?e===this.userID?this.leaveRoom():this.userList.leave(e):Promise.resolve()},isRoomOpened:function(e){if(null==e)return!1;if("closed"===e.filter.split("|")[0])return!1;var t=this.userID;if(e.moderators.hasOwnProperty(t))return!0;switch(e.permission){case"black-list":var i=e["black-list"];return!(i&&i.hasOwnProperty(t));case"white-list":i=e["white-list"];return i&&i.hasOwnProperty(t);default:return!0}},changeRoomState:function(i,r){1===arguments.length&&(r=i,i=void 0),void 0===i&&(i=this.roomID);var s=this;return this.hasRoom(i).then(function(e){var t;return e?(e=x(r,s.roomType),(t={})["room-filters/".concat(i,"/filter")]=e,t["room-data/".concat(i,"/filter")]=e,s.getRootRef().update(t)):Promise.resolve()})},changeFilterData:function(t,i){1===arguments.length&&(i=t,t=void 0),void 0===t&&(t=this.roomID);var r=this;return this.hasRoom(t).then(function(e){return e?r.getRoomFilterRef(t).child("data").update(i):Promise.resolve()})},changeUserName:function(e){return this.userList.changeUserName(e)},changeRoomName:function(t,i){1===arguments.length&&(i=t,t=void 0),void 0===t&&(t=this.roomID);var r=this;return this.hasRoom(t).then(function(e){return e?((e={})["room-filters/".concat(t,"/name")]=i,e["room-data/".concat(t,"/name")]=i,r.getRootRef().update(e)):Promise.resolve()})},openRoom:function(e){return this.setRoomState(e,"open")},closeRoom:function(e){return this.setRoomState(e,"closed")},getUserList:function(i){var r;return void 0===i?this.userList.getUsers():(r=this,new Promise(function(t,e){new k({itemIDKey:"joinAt",mode:"once"}).once("update",function(e){t(e)}).startUpdate(r.getUserListRef(i))}))},getRoomList:function(i,r){var s=this;return new Promise(function(t,e){s.roomList.once("roomlist.update",function(e){t(e)}).startUpdate(s.getRoomListQuery(i,r))})},hasRoom:function(e){return e===this.roomID?Promise.resolve(!0):this.getRoomDataRef(e).once("value").then(function(e){e=null!==e.val();return Promise.resolve(e)})}},F=(Object.assign(I,{getRootRef:function(e){var t=this.database.ref(this.rootPath);return t=e?t.child(e):t},getRoomRef:function(e,t){var i=this.getRootRef("rooms");return i=void 0!==e&&(i=i.child(e),void 0!==t)?i.child(t):i},getRoomAliveRef:function(e){return this.getRoomRef(e,"alive")},getUserListRef:function(e){return this.getRoomRef(e,"users")},getRoomFilterRef:function(e){var t=this.getRootRef("room-filters");return t=void 0!==e?t.child(e):t},getRoomDataRef:function(e){var t=this.getRootRef("room-data");return t=void 0!==e?t.child(e):t},getUserDataRef:function(e){var t=this.getRootRef("user-data");return t=void 0!==e?t.child(e):t},getRoomDataPath:function(e,t){e="".concat(this.rootPath,"/rooms/").concat(e);return t&&(e+="/".concat(t)),e},getUserListPath:function(e){return this.getRoomDataPath(e,"users")},getItemTablePath:function(e,t){return"".concat(this.getRoomDataPath(e,"tables"),"/").concat(t)},getRoomListQuery:function(e,t){void 0===t&&(t="open");var i=(i=this.getRoomFilterRef()).orderByChild("filter");return i=void 0===e?i.startAt(t).endAt("".concat(t,"~")):i.equalTo(x(t,e))}}),function(){function r(e){n(this,r);var t=y(e,"eventEmitter",void 0),i=y(e,"EventEmitterClass",void 0);this.setEventEmitter(t,i),this.database=firebase.database(),this.rootPath=y(e,"root",""),this.userInfo={userID:"",userName:""},this.setUser(y(e,"userID",""),y(e,"userName","")),this.isRoomCreator=!1,this.roomID=void 0,this.roomName=void 0,this.roomType=void 0,this.doorState=void 0,this.leftRoomFlag=!1,this.isRemoveRoomWhenLeft=void 0,this.userList=function(e){var t=new R({eventEmitter:this.getEventEmitter(),eventNames:{join:"userlist.join",leave:"userlist.leave",update:"userlist.update",change:"userlist.change",init:"userlist.init",changename:"userlist.changename"},userID:this.userInfo});return t.on("userlist.leave",function(e){e.userID===this.userID&&Ne.call(this)},this),this.on("room.join",function(){t.startUpdate()}).on("room.leave",function(){t.stopUpdate().clear()}),t}.call(this,e),this.roomList=function(e){return new k({eventEmitter:this.getEventEmitter(),root:this.getRoomFilterRef(),itemIDKey:"roomID",eventNames:{update:"roomlist.update",add:"roomlist.add",remove:"roomlist.remove",change:"roomlist.change"},mode:"once"})}.call(this,e),this.broadcast=function(e){var i,e=y(e,"broadcast",!0);return e?(i=new p({eventEmitter:this.getEventEmitter(),eventNames:{receive:"broadcast.receive"},receiverID:"boradcast",senderID:this.userInfo,history:y(e,"history",!1)}),this.on("room.join",function(e){i.setRootPath(this.getRoomDataPath(e.roomID)).startReceiving()},this).on("room.leave",function(){i.stopReceiving()},this).on("userlist.changename",function(e,t){i.changeUserName(e,t)},this),i):null}.call(this,e),this.tables=function(e){var t,i=y(e,"tables",void 0);if(void 0===i)return{};for(var r={},s=0,n=i.length;s<n;s++)r[(t=i[s]).key]=Ae.call(this,t);return r}.call(this,e)}return o(r,[{key:"shutdown",value:function(){var e=this;this.destroyEventEmitter().leaveRoom().then(function(){e.userList.destroy(),e.userList=void 0,e.roomList.destroy(),e.roomList=void 0,e.broadcast.destroy(),e.broadcast=void 0})}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"getRoomInfo",value:function(e,t){return{roomID:e=void 0===e?this.roomID:e,roomName:t=void 0===t?this.roomName:t}}},{key:"setUser",value:function(e,t){return l(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"isInRoom",value:function(e){return void 0===e?void 0!==this.roomID:this.roomID===e}},{key:"isFull",value:function(){return this.userList.isFull()}},{key:"isFirstUser",value:function(e){return this.userList.isFirstUser(e)}},{key:"getUsers",value:function(){return this.userList.getUsers()}},{key:"maxUsers",get:function(){return this.userList.maxUsers}},{key:"getTable",value:function(e){return this.tables[e]}}]),r}()),qe=(Object.assign(F.prototype,e,I),v.register("room",function(e){return new F(e)}),i(window,"RexPlugins.Fire.Room",F),function(){this.emit("room.leave");var e=this;setTimeout(function(){e.leftRoomFlag=!1},0)}),ze=function(e){var t=e.key,i=new w({eventEmitter:this.getEventEmitter(),root:this.getItemTablePath(t),type:y(e,"type",1),eventNames:{init:"tables.".concat(t,".init"),update:"tables.".concat(t,".update"),addkey0:"tables.".concat(t,".addkey0"),removekey0:"tables.".concat(t,".removekey0"),changekey0:"tables.".concat(t,".changekey0"),addkey1:"tables.".concat(t,".addkey1"),removekey1:"tables.".concat(t,".removekey1"),changekey1:"tables.".concat(t,".changekey1"),addkey2:"tables.".concat(t,".addkey2"),removekey2:"tables.".concat(t,".removekey2"),changekey2:"tables.".concat(t,".changekey2")}});return this.on("room.join",function(){i.startUpdate()}).on("room.leave",function(){i.clear().stopUpdate()}),i},D={joinRoom:function(){var e=this;return this.userList.join().then(function(){return e.emit("room.join"),Promise.resolve()})},leaveRoom:function(){return this.isInRoom()?(this.leftRoomFlag=!0,this.userList.leave()):Promise.resolve()},kickUser:function(e){return this.userList.contains(e)?e===this.userID?this.leaveRoom():this.userList.leave(e):Promise.resolve()},changeUserName:function(e){return this.userList.changeUserName(e)},getUserList:function(){return this.userList.getUsers()}},U=(Object.assign(D,{getRoomRef:function(e){var t=this.database.ref(this.rootPath);return t=e?t.child(e):t},getUserListRef:function(){return this.getRoomRef("users")},getRoomDataPath:function(e){var t=this.rootPath;return e&&(t+="/".concat(e)),t},getUserListPath:function(){return this.getRoomDataPath("users")},getItemTablePath:function(e){return"".concat(this.getRoomDataPath("tables"),"/").concat(e)}}),function(){function r(e){n(this,r);var t=y(e,"eventEmitter",void 0),i=y(e,"EventEmitterClass",void 0);this.setEventEmitter(t,i),this.database=firebase.database(),this.rootPath=y(e,"root",""),this.userInfo={userID:"",userName:""},this.setUser(y(e,"userID",""),y(e,"userName","")),this.leftRoomFlag=!1,this.userList=function(e){var t=new R({eventEmitter:this.getEventEmitter(),eventNames:{join:"userlist.join",leave:"userlist.leave",update:"userlist.update",change:"userlist.change",init:"userlist.init",changename:"userlist.changename"},root:this.getUserListPath(),userID:this.userInfo,maxUsers:y(e,"maxUsers",0)});return t.on("userlist.leave",function(e){e.userID===this.userID&&qe.call(this)},this),this.on("room.join",function(){t.startUpdate()}).on("room.leave",function(){t.stopUpdate().clear()}),t}.call(this,e),this.broadcast=function(e){var i,e=y(e,"broadcast",!0);return e?(i=new p({eventEmitter:this.getEventEmitter(),eventNames:{receive:"broadcast.receive"},root:this.rootPath,receiverID:"broadcast",senderID:this.userInfo,history:y(e,"history",!1)}),this.on("room.join",function(){i.startReceiving()}).on("room.leave",function(){i.stopReceiving()}).on("userlist.changename",function(e,t){i.changeUserName(e,t)},this),i):null}.call(this,e),this.tables=function(e){var t,i=y(e,"tables",void 0);if(void 0===i)return{};for(var r={},s=0,n=i.length;s<n;s++)r[(t=i[s]).key]=ze.call(this,t);return r}.call(this,e)}return o(r,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"setUser",value:function(e,t){return l(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"isInRoom",value:function(){return this.userList.isInList}},{key:"isFull",value:function(){return this.userList.isFull()}},{key:"isFirstUser",value:function(e){return this.userList.isFirstUser(e)}},{key:"getUsers",value:function(){return this.userList.getUsers()}},{key:"maxUsers",get:function(){return this.userList.maxUsers}},{key:"getTable",value:function(e){return this.tables[e]}}]),r}()),He=(Object.assign(U.prototype,e,D),v.register("singleRoom",function(e){return new U(e)}),i(window,"RexPlugins.Fire.SingleRoom",U),v.register("itemTable",function(e){return new w(e)}),i(window,"RexPlugins.Fire.ItemTable",w),function(e){return void 0===e.totalLines&&(e.totalLines=1/0),void 0===e.linesPerPage&&(e.linesPerPage=1e3),e.remainderLines=e.totalLines,$(e)}),L=function(e,t,s,i,r){var n=[],o=0;return He({query:e,totalLines:(s=void 0===s?0:s)+(t=void 0===t?1/0:t),startDocRef:i,startMode:r,forEachPageCallback:function(e){var t,i=e.size,r=s-o;r<=0?t=e.docs:r<i&&(t=e.docs.slice(r,i)),t&&n.push.apply(n,O(t)),o+=i},resolveCallback:function(){return n}})},C=function(){function t(e){n(this,t),this.setItemCount(y(e,"itemCount",100)),this.setQuery(y(e,"query",void 0)),this.setDataMode(y(e,"dataMode",0)),this.setBaselineDoc(y(e,"baselineDoc",void 0),y(e,"baselineMode",void 0)),this.pageIndex=void 0,this.baselineDocRef=void 0,this.baselineMode="startAt",this.startItemIndex=void 0,this.endItemIndex=void 0,this.cacheItems=void 0,this.isFullPage=void 0}return o(t,[{key:"setItemCount",value:function(e){return this.itemCount=e,this}},{key:"setQuery",value:function(e,t){var i;return l(e)?(this.nextQuery=(i=e).next,this.prevQuery=i.previous):(this.nextQuery=e,this.prevQuery=t),this.pageIndex=void 0,this.isFullPage=void 0,this}},{key:"setDataMode",value:function(e){return"string"==typeof e&&(e=Ve[e]),this.dataMode=e,this}},{key:"setBaselineDoc",value:function(e,t){return e?(this.baselineDocRef=e.ref,this.baselineMode=t):this.baselineDocRef=void 0,this}}]),t}(),Ve=(Object.assign(C.prototype,{loadFirstPage:function(){return(0===this.dataMode?ee:te).call(this)},loadNextPage:function(){return void 0===this.pageIndex?this.loadFirstPage():(0===this.dataMode?ie:re).call(this)},loadPreviousPage:function(){return void 0===this.pageIndex||1===this.pageIndex?this.loadFirstPage():(0===this.dataMode?se:ne).call(this)},loadCurrentPage:function(){return void 0===this.pageIndex||0===this.pageIndex?this.loadFirstPage():(0===this.dataMode?oe:ae).call(this)},load:function(i,r){void 0===r&&(r=0);var s=this;return L(this.nextQuery,i,r,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return s.cacheItems=e,s.pageIndex=void 0,s.startItemIndex=r,s.endItemIndex=s.startItemIndex+t-1,s.isFullPage=void 0===i||t===i,Promise.resolve(s.cacheItems)})}}),{static:0,dynamic:1}),We=(v.register("pageLoader",function(e){return new C(e)}),i(window,"RexPlugins.Fire.PageLoader",C),function(e){var t=e.data();return t.headerDocID=e.id,t}),Ye=function(){function t(e){n(this,t),this.database=firebase.firestore(),this.setRootPath(y(e,"root","")),this.cacheHeaders={},this.userInfo={userID:""},this.setOwner(y(e,"userID",""))}return o(t,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setOwner",value:function(e){var t=this.userID;return l(e)?this.userInfo=e:this.userID=e,t!==this.userID&&this.clearCache(),this}},{key:"clearCache",value:function(){return c(this.cacheHeaders),this}},{key:"getFileQuery",value:function(e,t,i){var r=this.rootRef,r=e?r.where("userID","==",e):r;return r=t?r.where("fileID","==",t):r,r=i?r.where("type","==",i):r}}]),t}(),Ge=(Object.assign(Ye.prototype,{save:function(t,r,s,e){"boolean"==typeof s&&(e=s,s=void 0),void 0===e&&(e=!1);var i=this.userID,n=((r=void 0===r?{}:r).userID=i,r.fileID=t,r.type="header",s&&(s.userID=i,s.fileID=t,s.type="content"),e?"update":"set"),o=this;return function(i){var r,e=this.userID,t=this.cacheHeaders[i];return t&&t.userID===e?Promise.resolve(t):(r=this).getFileQuery(e,i,"header").limit(1).get().then(function(e){var t=void 0;return 0<e.size&&(e=e.docs[0],t=We(e),r.cacheHeaders[i]=t),Promise.resolve(t)})}.call(this,t).then(function(e){e?(t=o.rootRef.doc(e.headerDocID),s&&(i=e.contentDocID?o.rootRef.doc(e.contentDocID):o.rootRef.doc())):(t=o.rootRef.doc(),s&&(i=o.rootRef.doc())),r.hasOwnProperty("headerDocID")&&delete r.headerDocID,i&&(r.contentDocID=i.id);var t,i,e=o.database.batch();return e[n](t,r),s&&e[n](i,s),e.commit()}).then(function(){return Promise.resolve({userID:i,fileID:t})}).catch(function(e){return Promise.reject({error:e,userID:i,fileID:t})})},load:function(r){var s=this.userID;return this.getFileQuery(s,r).get().then(function(e){var t,i;return e.forEach(function(e){switch(docData.type){case"header":t=We(e);break;case"content":i=e.data()}}),Promise.resolve({userID:s,fileID:r,header:t,content:i})}).catch(function(){return Promise.reject({error:error,userID:s,fileID:r})})},loadHeaders:function(){var i=this.userID,r=this;return this.getFileQuery(i,void 0,"header").get().then(function(e){var t;return c(r.cacheHeaders),e.forEach(function(e){t=We(e),r.cacheHeaders[t.fileID]=t}),Promise.resolve({userID:i,headers:r.cacheHeaders})}).catch(function(){return Promise.reject({error:error,userID:i})})},delete:function(i){var r=this.userID,s=this;return LoadHeader.call(this,i).then(function(e){var t;return e?((t=s.database.batch()).delete(s.rootRef.doc(e.headerDocID)),e.contentDocID&&t.delete(s.rootRef.doc(e.contentDocID)),t.commit()):Promise.resolve({userID:r,fileID:i})}).then(function(){return s.cacheHeaders.hasOwnProperty(i)&&delete s.cacheHeaders[i],Promise.resolve({userID:r,fileID:i})}).catch(function(e){return Promise.reject({error:e,userID:r,fileID:i})})},clear:function(){var t=this.userID,r=this;return this.getFileQuery(t,void 0,"header").get().then(function(e){var t,i=r.database.batch();return e.forEach(function(e){t=DocToHeader(e),i.delete(r.rootRef.doc(t.headerDocID)),t.contentDocID&&i.delete(r.rootRef.doc(t.contentDocID))}),i.commit()}).then(function(){return r.clearCache(),Promise.resolve({userID:t})}).catch(function(e){return Promise.reject({error:e,userID:t})})}}),v.register("files",function(e){return new Ye(e)}),i(window,"RexPlugins.Fire.Files",Ye),function(r,s){var e=this;return this.database.runTransaction(function(t){var i=e.getAliasRef(s);return t.get(i).then(function(e){return e.exists?Promise.reject({id:r,alias:s}):(t.set(i,{id:r}),Promise.resolve({id:r,alias:s}))})})}),Je=function(){function t(e){n(this,t),this.database=firebase.firestore(),this.setRootPath(y(e,"root",""))}return o(t,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"getAliasRef",value:function(e){return this.rootRef.doc(e)}}]),t}(),j=(Object.assign(Je.prototype,{add:function(t,i){var r=this;return this.getAlias(t).then(function(e){return e.alias?e.alias===i?Promise.resolve({id:t,alias:i}):Promise.reject({id:t,alias:i}):Ge.call(r,t,i)})},addRandom:function(i,e){var r=y(e,"digits",10),s=y(e,"candidates","0123456789"),n=y(e,"retry",1e3),o=this;return this.getAlias(i).then(function(e){var t;return e.alias?(t=N(r,r,s),e.alias===t?Promise.resolve({id:i,alias:t}):Promise.reject({id:i,alias:t})):m.call(o,i,r,s,n)})},getId:function(i){return this.getAliasRef(i).get().then(function(e){var t;return e.exists&&(t=e.data().id),Promise.resolve({id:t,alias:i})})},getAlias:function(i){return this.rootRef.where("id","==",i).limit(1).get().then(function(e){var t;return 0<e.size&&(t=e.docs[0].id),Promise.resolve({id:i,alias:t})})},getRandomAlias:function(t,e){var i=y(e,"digits",10),r=y(e,"candidates","0123456789"),s=y(e,"retry",1e3),n=this;return this.getAlias(t).then(function(e){return e.alias?Promise.resolve(e):m.call(n,t,i,r,s)})},remove:function(e){var t=this;return this.getAlias(e).then(function(e){return t.getAliasRef(e).delete()})}}),v.register("idAlias",function(e){return new Je(e)}),i(window,"RexPlugins.Fire.IdAlias",Je),{d:"tagD",w:"tagW",m:"tagM",y:"tagY",a:"tagA"}),M={d:"scoreD",w:"scoreW",m:"scoreM",y:"scoreY",a:"scoreA"},Pe={loadFirstPage:function(){this.resetPageQuery();var t=this;return this.page.loadFirstPage().then(function(e){return Promise.resolve(_.call(t,e))})},loadNextPage:function(){this.resetPageQuery();var t=this;return this.page.loadNextPage().then(function(e){return Promise.resolve(_.call(t,e))})},loadPreviousPage:function(){this.resetPageQuery();var t=this;return this.page.loadPreviousPage().then(function(e){return Promise.resolve(_.call(t,e))})},loadCurrentPage:function(){this.resetPageQuery();var t=this;return this.page.loadCurrentPage().then(function(e){return Promise.resolve(_.call(t,e))})},load:function(e,t){this.resetPageQuery();var i=this;return this.page.load(e,t).then(function(e){return Promise.resolve(_.call(i,e))})},resetPageQuery:function(){return this.resetQueryFlag&&(this.resetQueryFlag=!1,this.page.setQuery(this.getPageQuery())),this}},_=function(e){for(var t,i=[],r=M[this.timeFilterType[0]],s=0,n=e.length;s<n;s++){if(t=e[s].data(),!1!==this.timeFilters)for(var o in t.score=t[r],this.timeFilters)delete t[j[o]],delete t[M[o]];i.push(t)}return i},g={deleteUser:function(e){void 0===e&&(e=this.userID);e=this.getRecordQuery(void 0,void 0,e,void 0);return he(e)},deleteBoard:function(e,t){void 0===e&&(e=this.boardID),void 0===t&&(t=this.tag);e=this.getRecordQuery(e,t,void 0,void 0);return he(e)}},I={getRecordQuery:function(e,t,i,r){var s=this.rootRef,s=void 0!==e?s.where("boardID","==",e):s;return s=void 0!==t?s.where("tag","==",t):s,s=void 0!==i?s.where("userID","==",i):s,s=void 0!==r?s.where(r[0],"==",r[1]):s},getMyRecordQuery:function(e){return void 0===e&&(e=this.userID),this.getRecordQuery(this.boardID,this.tag,e,void 0).limit(1)},getPageQuery:function(){e=!1!==this.timeFilters?(e=this.timeFilterType[0],t=[j[e],ue()[e]],M[e]):(t=void 0,"score");var e,t=this.getRecordQuery(this.boardID,this.tag,void 0,t);return{next:t.orderBy(e,"desc"),previous:t.orderBy(e)}}},Xe=function(){function t(e){n(this,t),this.database=firebase.firestore(),this.setRootPath(y(e,"root","")),this.userInfo={userID:void 0,userName:void 0},this.setUser(y(e,"userID",""),y(e,"userName",void 0)),this.setBoardID(y(e,"boardID",void 0)),this.setTag(y(e,"tag",void 0)),this.setTimeFilters(y(e,"timeFilters",!1)),this.setTimeFilterType(y(e,"timeFilterType","year")),this.page=new C({dataMode:"dynamic",itemCount:y(e,"pageItemCount",100)}),this.resetQueryFlag=!0}return o(t,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"setRootPath",value:function(e){return this.resetQueryFlag|=this.rootPath!==e,this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setUser",value:function(e,t){return l(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setBoardID",value:function(e){return this.resetQueryFlag|=this.boardID!==e,this.boardID=e,this}},{key:"setTag",value:function(e){return this.resetQueryFlag|=this.tag!==e,this.tag=e,this}},{key:"setTimeFilters",value:function(e){return this.timeFilters=!1!==e&&{d:y(e,"day",!0),w:y(e,"week",!0),m:y(e,"month",!0),y:y(e,"year",!0),a:y(e,"all",!0)},this}},{key:"setTimeFilterType",value:function(e){return this.resetQueryFlag|=this.timeFilterType!==e,this.timeFilterType=e,this}},{key:"setPageItemCount",value:function(e){return this.page.setItemCount(e),this}},{key:"pageIndex",get:function(){return this.page.pageIndex}},{key:"isFirstPage",get:function(){return 0===this.page.pageIndex}},{key:"isLastPage",get:function(){return!1===this.page.isFullPage}}]),t}(),D=(Object.assign(Xe.prototype,{post:function(e,t,i){var n={userID:this.userID},r=(void 0!==this.boardID&&(n.boardID=this.boardID),this.userName&&(n.userName=this.userName),ue(i));if(!1!==this.timeFilters)for(var s in this.timeFilters)this.timeFilters[s]&&(n[j[s]]=r[s],n[M[s]]=e);else n.score=e;this.tag&&(n.tag=this.tag),t&&Object.assign(n,t);var o=this;return this.getMyRecordQuery().get().then(function(e){var t,i,r;if(0<e.size&&(t=(e=e.docs[0]).data(),i=e.id),t)if(!1!==o.timeFilters)for(var s in o.timeFilters)o.timeFilters[s]&&t[r=j[s]]===n[r]&&(n[r=M[s]]=Math.max(t[r],n[r]));else n.score=Math.max(t.score,n.score);return void 0===i&&(i=o.rootRef.doc().id),o.rootRef.doc(i).set(n)})},getScore:function(e){return this.getMyRecordQuery(e).get().then(function(e){var t;return 0<e.size&&(t=e.docs[0].data()),Promise.resolve(t)})},getRank:function(t){void 0===t&&(t=this.userID);var n,o,a,e=this.getPageQuery().next;return n=function(e){return e.data().userID===t},o={doc:void 0,index:void 0},a=0,He({query:e,forEachPageCallback:function(e){for(var t,i=e.docs,r=0,s=i.length;r<s;r++)if(t=i[r],n(t))return o.doc=t,o.index=a+r,!0;a+=e.size},resolveCallback:function(){return o}}).then(function(e){return Promise.resolve({userID:t,rank:e.index})})}},I,Pe,g),v.register("leaderBoard",function(e){return new Xe(e)}),i(window,"RexPlugins.Fire.LeaderBoard",Xe),{startReceiving:function(){var e=this.getReceiverQuery(this.receiverID).orderBy("timestamp","desc").limit(1),t=this;return this.unsubscribe=e.onSnapshot({includeMetadataChanges:!0},function(e){!(0<e.size)||(e=e.docs[0]).metadata.hasPendingWrites?t.skipFirst&&(t.skipFirst=!1):(t.resetPageQuery(t.receiverID,e),t.skipFirst?t.skipFirst=!1:(e=Ze(e),t.cacheMessages.push(e),t.emit("receive",e)))},function(e){}),this},stopReceiving:function(){return this.unsubscribe&&this.unsubscribe(),this.resetQueryFlag=!0,this.cacheMessages.length=0,this},loadPreviousMessages:function(){this.resetPageQuery(this.receiverID);var n=this;return this.page.loadNextPage().then(function(e){for(var t,i=[],r=0,s=e.length;r<s;r++)i.push(Ze(e[r]));return(t=n.cacheMessages).splice.apply(t,[0,0].concat(i)),Promise.resolve(i)})},resetPageQuery:function(e,t){var i;return this.resetQueryFlag&&(this.resetQueryFlag=!1,i=this.skipFirst?"startAt":"startAfter",this.page.setBaselineDoc(t,i).setQuery(this.getPageQuery(e))),this}}),Ze=function(e){e=e.data();return e.timestamp=1e3*e.timestamp.seconds,e},I={getReceiverQuery:function(e){void 0===e&&(e=this.receiverID);var t=this.rootRef;return t=void 0!==e?t.where("receiverID","==",e):t},getPageQuery:function(e){e=this.getReceiverQuery(e);return{next:e.orderBy("timestamp"),previous:e.orderBy("timestamp","desc")}}},$e=function(){function r(e){n(this,r);var t=y(e,"eventEmitter",void 0),i=y(e,"EventEmitterClass",void 0);this.setEventEmitter(t,i),this.database=firebase.firestore(),this.setRootPath(y(e,"root","")),this.userInfo={userID:"",userName:void 0},this.setSender(y(e,"senderID",""),y(e,"senderName","")),this.setReceiver(y(e,"receiverID",void 0)),this.skipFirst=!0,this.unsubscribe=void 0,this.page=new C,this.setPageItemCount(y(e,"pageItemCount",100)),this.resetQueryFlag=!0,this.cacheMessages=[]}return o(r,[{key:"shutdown",value:function(){this.stopReceiving().destroyEventEmitter()}},{key:"destroy",value:function(){this.shutdown()}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"setRootPath",value:function(e){return this.resetQueryFlag|=this.rootPath!==e,this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setSender",value:function(e,t){return l(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setReceiver",value:function(e){return this.resetQueryFlag|=this.receiverID!==e,this.receiverID=e,this}},{key:"setPageItemCount",value:function(e){return this.page.setItemCount(e),this}},{key:"hasPreviousMessage",get:function(){return!1!==this.page.isFullPage}}]),r}();return Object.assign($e.prototype,e,{send:function(e){e={senderID:this.userID,message:e,timestamp:firebase.firestore.FieldValue.serverTimestamp()};return void 0!==this.userName&&(e.senderName=this.userName),void 0!==this.receiverID&&(e.receiverID=this.receiverID),this.rootRef.add(e)}},D,I),v.register("messages",function(e){return new $e(e)}),i(window,"RexPlugins.Fire.Messages",$e),function(){s(i,Phaser.Plugins.BasePlugin);var t=h(i);function i(e){return n(this,i),(e=t.call(this,e)).add=new v,e}return o(i,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}},{key:"initializeApp",value:function(e){return this.add.initializeApp(e),this}},{key:"preload",value:function(e,t,i){return K.call(e.sys.load,t,i),this}}]),i}()});
