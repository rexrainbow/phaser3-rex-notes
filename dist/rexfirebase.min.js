!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).rexfirebase=t()}(this,function(){"use strict";function u(e){return(u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function n(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}function s(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&r(e,t)}function a(e){return(a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function r(e,t){return(r=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function c(i){var s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=a(i);if(s){var r=a(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return h(this,e)}}function l(e){return function(e){if(Array.isArray(e))return f(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(!e)return;if("string"==typeof e)return f(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return f(e,t)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,i=new Array(t);r<t;r++)i[r]=e[r];return i}function d(e){if(Array.isArray(e))e.length=0;else for(var t in e)delete e[t]}function m(e,t){var r=function(e,t){var r=Array.isArray(e);if(void 0===t?t=r?[]:{}:d(t),r){t.length=e.length;for(var i=0,s=e.length;i<s;i++)t[i]=e[i]}else for(var n in e)t[n]=e[n];return t}(e);for(var i in t)r.hasOwnProperty(i)&&(r[i]=t[i]);return r}function v(r){return new Promise(function(e,t){!function(e,t){for(var r=document.getElementsByTagName("script"),i=0,s=r.length;i<s;i++)if(-1!=r[i].src.indexOf(e))return t&&t();var n=document.createElement("script");n.setAttribute("src",e),t&&(n.onload=t),document.head.appendChild(n)}(r,e)})}function y(r,i){return void 0===r&&(r=0),new Promise(function(e,t){setTimeout(function(){e(i)},r)})}function g(i,e){return i=m(t,i),v(i.app).then(function(){var e,t=[];for(var r in i)"app"!==r&&(e=i[r])&&t.push(v(e));return 0===t.length?Promise.resolve():Promise.all(t)}).then(function(){return function e(t){return p(t)?Promise.resolve():y(10).then(function(){return e(t)})}(i)}).then(function(){return void 0!==e&&firebase.initializeApp(e),Promise.resolve()})}var e="7.7.0",t={app:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-app.js"),database:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-database.js"),firestore:"https://www.gstatic.com/firebasejs/".concat(e,"/firebase-firestore.js")},p=function(e){var t;for(var r in e)if(e[r]&&(t=I[r])&&!t())return!1;return!0},I={database:function(){return void 0!==firebase.database},firestore:function(){return void 0!==firebase.firestore}},D=function(){function r(){n(this,r)}return o(r,[{key:"initializeApp",value:function(e){return firebase.initializeApp(e),this}}],[{key:"register",value:function(e,t){r.prototype[e]=t}}]),r}(),k={setEventEmitter:function(e,t){return void 0===t&&(t=Phaser.Events.EventEmitter),this._privateEE=void 0===e,this._eventEmitter=this._privateEE?new t:e,this},destroyEventEmitter:function(){return this._eventEmitter&&this._privateEE&&this._eventEmitter.shutdown(),this},getEventEmitter:function(){return this._eventEmitter},on:function(){return this._eventEmitter&&this._eventEmitter.on.apply(this._eventEmitter,arguments),this},once:function(){return this._eventEmitter&&this._eventEmitter.once.apply(this._eventEmitter,arguments),this},off:function(){return this._eventEmitter&&this._eventEmitter.off.apply(this._eventEmitter,arguments),this},emit:function(e){return this._eventEmitter&&e&&this._eventEmitter.emit.apply(this._eventEmitter,arguments),this},addListener:function(){return this._eventEmitter&&this._eventEmitter.addListener.apply(this._eventEmitter,arguments),this},removeListener:function(){return this._eventEmitter&&this._eventEmitter.removeListener.apply(this._eventEmitter,arguments),this},removeAllListeners:function(){return this._eventEmitter&&this._eventEmitter.removeAllListeners.apply(this._eventEmitter,arguments),this},listenerCount:function(){return this._eventEmitter?this._eventEmitter.listenerCount.apply(this._eventEmitter,arguments):0},listeners:function(){return this._eventEmitter?this._eventEmitter.listeners.apply(this._eventEmitter,arguments):[]}},R=function(e,t,r){if(e&&"number"!=typeof e){if(e.hasOwnProperty(t))return e[t];if(-1===t.indexOf("."))return r;for(var i=t.split("."),s=e,n=r,o=0;o<i.length;o++){if(!s.hasOwnProperty(i[o])){n=r;break}n=s[i[o]],s=s[i[o]]}return n}return r},b=function(e){if("object"!==u(e)||e.nodeType||e===e.window)return!1;try{if(e.constructor&&!{}.hasOwnProperty.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(e){return!1}return!0},P={startReceiving:function(){return this.isReceiving&&this.receiverRef.key===this.receiverID||(this.stopReceiving(),this.isReceiving=!0,this.skipFirst=!0,this.receiverRef=this.database.ref(this.rootPath).child(this.receiverID),this.receiverRef.on("value",E,this),this.receiverRef.onDisconnect().remove()),this},stopReceiving:function(){return this.isReceiving&&(this.isReceiving=!1,this.receiverRef.off("value",E,this),this.receiverRef.remove(),this.receiverRef.onDisconnect().cancel()),this}},E=function(e){if(this.skipFirst)this.skipFirst=!1;else{var t=e.val();null!=t&&(delete t.stamp,this.history.add(t),this.emit(this.eventNames.receive,t))}},w=function(){function t(e){n(this,t),this.maxLength=R(e,"maxLength",-1),this.records=[]}return o(t,[{key:"add",value:function(e){return 0===this.maxLength||(this.records.push(e),0<this.maxLength&&this.records.length>this.maxLength&&this.records.shift()),this}},{key:"clear",value:function(){return this.records.length=0,this}},{key:"changeUserName",value:function(t,r){return 0===this.maxLength||this.records.forEach(function(e){e.senderID===t&&(e.senderName=r)}),this}}]),t}(),x=function(){function s(e){n(this,s);var t=R(e,"eventEmitter",void 0),r=R(e,"EventEmitterClass",void 0);this.setEventEmitter(t,r),this.eventNames=R(e,"eventNames",L),this.database=firebase.database(),this.setRootPath(R(e,"root","")),this.skipFirst=!0,this.stamp=!1,this.userInfo={userID:"",userName:void 0},this.setSender(R(e,"senderID",""),R(e,"senderName","")),this.setReceiver(R(e,"receiverID","")),this.isReceiving=!1;var i=R(e,"history",0);!0===i?i=-1:!1===i&&(i=0),this.history=new w({maxLength:i})}return o(s,[{key:"shutdown",value:function(){this.stopReceiving().destroyEventEmitter()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.sendToRef=void 0,this.receiverRef=void 0,this}},{key:"setSender",value:function(e,t){return b(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setReceiver",value:function(e){return this.receiverID=e,this}},{key:"changeUserName",value:function(e,t){return e===this.userID&&(this.userName=t),this.history.changeUserName(e,t),this}},{key:"getHistory",value:function(){return this.history.records}},{key:"clearHistory",value:function(){return this.history.clear(),this}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}}]),s}(),N={send:function(e){if(this.sendToRef&&this.sendToRef.key===this.receiverID||(this.sendToRef=this.database.ref(this.rootPath).child(this.receiverID)),void 0===e)return this.sendToRef.remove();var t={message:e,senderID:this.userID,stamp:this.stamp};return void 0!==this.userName&&(t.senderName=this.userName),this.skipFirst=!1,this.stamp=!this.stamp,this.sendToRef.set(t)}};Object.assign(x.prototype,k,P,N);function F(e){return null==e||""===e||0===e.length}function U(e,t,r){if("object"===u(e)){if(F(t)){if(null==r)return;"object"===u(r)&&(e=r)}else{"string"==typeof t&&(t=t.split("."));var i=t.pop();(function(e,t,r){var i=e;if(!F(t)){var s;"string"==typeof t&&(t=t.split("."));for(var n=0,o=t.length;n<o;n++){var a;if(null==i[s=t[n]]||"object"!==u(i[s]))a=n!==o-1||void 0===r?{}:r,i[s]=a;i=i[s]}}return i})(e,t)[i]=r}return e}}var L={receive:"receive"};D.register("broadcast",function(e){return new x(e)}),U(window,"RexPlugins.Fire.Broadcast",x);function C(e,t){var r=O.call(this,e,t);this.updateItemID2Index(),this.emit(this.eventNames.add,r),this.emit(this.eventNames.update,this.items)}function j(e,t){var r=M.call(this,e);this.updateItemID2Index();var i=O.call(this,e,t);this.updateItemID2Index(),this.emit(this.eventNames.change,i,r),this.emit(this.eventNames.update,this.items)}function _(e){var t=M.call(this,e);this.updateItemID2Index(),this.emit(this.eventNames.remove,t),this.emit(this.eventNames.update,this.items)}function Q(e){this.clear(),e.forEach(function(e){O.call(this,e,null,!0)}.bind(this)),this.updateItemID2Index(),this.emit(this.eventNames.update,this.items)}var A={clear:function(){return this.items.length=0,d(this.itemID2Index),this},getItems:function(){return this.items},hasItem:function(e){return this.itemID2Index.hasOwnProperty(e)},getItemIndexFromItemID:function(e){return null==e?null:this.itemID2Index[e]},getItemFromItemID:function(e){if(null==e)return null;var t=this.getItemIndexFromItemID(e);return null==t?null:this.items[t]},forEach:function(e,t){return this.items.forEach(e,t),this},updateItemID2Index:function(){var e;d(this.itemID2Index);for(var t=0,r=this.items.length;t<r;t++)e=this.items[t][this.keyItemID],this.itemID2Index[e]=t;return this}},T=function(e,t){if(!(t>=e.length)){for(var r=e.length-1,i=e[t],s=t;s<r;s++)e[s]=e[s+1];return e.length=r,i}},O=function(e,t,r){var i,s=this.getItemCallback,n=this.getItemCallbackScope;if(i=n?s.call(n,e):s(e),r)return this.items.push(i),i;if(null==t)this.items.unshift(i);else{var o=this.itemID2Index[t];o===this.items.length-1?this.items.push(i):this.items.splice(o+1,0,i)}return i},M=function(e){var t=this.itemID2Index[e.key];return T(this.items,t)},S={start:function(e){return this.isUpdating=!1,e.once("value",Q,this),this},stop:function(){return this}},K={start:function(e){return e.on("child_added",C,this),e.on("child_removed",_,this),e.on("child_moved",j,this),e.on("child_changed",j,this),this},stop:function(){return this.query.off("child_added",C,this),this.query.off("child_removed",_,this),this.query.off("child_moved",j,this),this.query.off("child_changed",j,this),this}},B={start:function(e){return e.on("value",Q,this),this},stop:function(){return this.query.off("value",Q,this),this}},q=function(){function i(e){n(this,i);var t=R(e,"eventEmitter",void 0),r=R(e,"EventEmitterClass",void 0);this.setEventEmitter(t,r),this.eventNames=R(e,"eventNames",H),this.isUpdating=!1,this.items=[],this.itemID2Index={},this.setItemIDKey(R(e,"itemIDKey","__itemID__")),this.setMode(R(e,"mode",1)),this.setGetitemCallback(R(e,"getItemCallback",z),R(e,"getItemCallbackScope",this)),this.setQuery(R(e,"query",void 0))}return o(i,[{key:"shutdown",value:function(){this.stopUpdate().clear()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setItemIDKey",value:function(e){return this.keyItemID=e,this}},{key:"setMode",value:function(e){return"string"==typeof e&&(e=W[e]),this.mode=e,this.updater=V[e],this}},{key:"setGetitemCallback",value:function(e,t){return this.getItemCallback=e,this.getItemCallbackScope=t,this}},{key:"setQuery",value:function(e){return this.query=e,this}},{key:"startUpdate",value:function(e){if(e)this.setQuery(e);else{if(!this.query)return this;e=this.query}return this.stopUpdate().clear(),this.isUpdating=!0,this.updater.start.call(this,e),this}},{key:"stopUpdate",value:function(){return this.query&&this.isUpdating&&(this.isUpdating=!1,this.updater.stop.call(this)),this}}]),i}(),z=function(e){var t=e.val();return t[this.keyItemID]=e.key,t};Object.assign(q.prototype,k,A);var H={update:"update",add:"add",remove:"remove",change:"change"},V={0:S,1:K,2:B},W={once:0,child:1,all:2},Y=function(e,t){var r=!1;return e.forEach(function(e){if(e.val().userID===t)return r=!0}),r},J=function(){function i(e){n(this,i);var t=R(e,"eventEmitter",void 0),r=R(e,"EventEmitterClass",void 0);this.setEventEmitter(t,r),this.database=firebase.database(),this.setRootPath(R(e,"root","")),this.userInfo={userID:"",userName:""},this.setUser(R(e,"userID",""),R(e,"userName","")),this.setMaxUsers(R(e,"maxUsers",0)),this.userList=new q({eventEmitter:this.getEventEmitter(),itemIDKey:"joinAt",eventNames:{add:R(e,"eventNames.join","join"),remove:R(e,"eventNames.leave","leave"),update:R(e,"eventNames.update","update"),change:R(e,"eventNames.change","change"),init:R(e,"eventNames.init","init"),changename:R(e,"eventNames.changename","changename")}}),this.isInList=!1,this.userID2ItemID={},this.userList.on(this.userList.eventNames.add,function(e){this.userID2ItemID[e.userID]=e.joinAt,e.userID===this.userInfo.userID&&this.emit(this.userList.eventNames.init,this.getUsers())},this).on(this.userList.eventNames.remove,function(e){delete this.userID2ItemID[e.userID],e.userID===this.userID&&(this.isInList=!1)},this).on(this.userList.eventNames.change,function(e,t){var r=e.userID,i=e.userName,s=t.userName;i!==s&&this.emit(this.userList.eventNames.changename,r,i,s)},this)}return o(i,[{key:"shutdown",value:function(){this.stopUpdate().destroyEventEmitter().leave(),this.userList.shutdown()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.rootPath=e,this}},{key:"setUser",value:function(e,t){return b(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setMaxUsers",value:function(e){return this.maxUsers=e,this}},{key:"clear",value:function(){return this.userList.clear(),this}},{key:"forEach",value:function(e,t){return this.userList.forEach(e,t),this}},{key:"isFull",value:function(){return 0!==this.maxUsers&&this.userList.getItems().length>=this.maxUsers}},{key:"isFirstUser",value:function(e){void 0===e&&(e=this.userID);var t=this.usersList.getItems()[0];return t&&t.userID===e}},{key:"getUser",value:function(e){if(void 0===e&&(e=this.userID),!this.contains(e))return null;var t=this.userID2ItemID[e];return this.userList.getItemFromItemID(t)}},{key:"getUsers",value:function(){return this.userList.getItems()}},{key:"getUserRef",value:function(e){if(void 0===e&&(e=this.userID),!this.contains(e))return null;var t=this.userID2ItemID[e];return this.rootRef.child(t)}},{key:"contains",value:function(e){return void 0===e&&(e=this.userID),this.userID2ItemID.hasOwnProperty(e)}},{key:"startUpdate",value:function(){var e=this.database.ref(this.rootPath);return 0<this.maxUsers&&(e=e.limitToFirst(this.maxUsers)),this.userList.startUpdate(e),this}},{key:"stopUpdate",value:function(){return this.userList.stopUpdate(),this}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"rootRef",get:function(){return this.database.ref(this.rootPath)}}]),i}(),G={join:function(t,e){if(void 0===t&&(t=this.userID,e=this.userName),this.contains(t))return Promise.resolve();var r={userID:t,userName:e},i=this.maxUsers,s=this.database.ref(this.rootPath),n=s.push();return n.onDisconnect().remove().then(function(){return n.set(r)}).then(function(){return y(0)}).then(function(){return 0===i?(self.isInList=!0,Promise.resolve()):s.limitToFirst(i).once("value").then(function(e){return Y(e,t)?(self.isInList=!0,Promise.resolve()):(self.isInList=!1,n.remove().then(function(){return n.onDisconnect().cancel()}).then(function(){return Promise.reject()}))})})},leave:function(e){if(void 0===e&&(e=this.userID),!this.contains(e))return Promise.resolve();var t=this.userID2ItemID[e];return this.database.ref(this.rootPath).child(t).remove()},changeUserName:function(t){var i=this;return new Promise(function(t,e){var r=i.getUserRef();r?t(r):i.rootRef.orderByChild("userID").equalTo(i.userID).once("child_added").then(function(e){t(e.ref)})}).then(function(e){return e.child("userName").set(t)}).then(function(){return i.userName=t,Promise.resolve()})}};Object.assign(J.prototype,k,G),D.register("onlineUserList",function(e){return new J(e)}),U(window,"RexPlugins.Fire.OnlineUserList",J);var X=function(){this.emit("room.leave");var e=this;setTimeout(function(){e.roomID=void 0,e.roomName=void 0,e.doorState=void 0,e.leftRoomFlag=!1},0)},Z=function(){function e(){n(this,e),this.data={}}return o(e,[{key:"setValue",value:function(e,t){return void 0===e?this.clear():void 0===t?this.data=e:U(this.data,e,t),this}},{key:"getValue",value:function(e){if(void 0===e)return this.data;"string"==typeof e&&(e=e.split("."));for(var t=this.data,r=0,i=e.length;r<i;r++){if(!$(t))return;t=t[e[r]]}return t}},{key:"cloneValue",value:function(e){return t=this.getValue(e),JSON.parse(JSON.stringify(t));var t}},{key:"removeKey",value:function(e){if(void 0===e)this.clear();else{"string"==typeof e&&(e=e.split("."));for(var t=e.pop(),r=this.data,i=0,s=e.length;i<s;i++){if(!$(r))return this;r=r[e[i]]}$(r)&&delete r[t]}return this}},{key:"clear",value:function(){return d(this.data),this}}]),e}(),$=function(e){return null!=e&&"object"===u(e)},ee=function(){function s(e){n(this,s),this.setEventEmitter(e.eventEmitter,e.EventEmitterClass),this.parent=e.parent,this.key=e.key,this.parent?this.fullKeyPath=te(this.parent.fullKeyPath,this.key):this.fullKeyPath="",this.type=e.type,this.eventNames=e.eventNames,this.table=e.table,this.database=firebase.database(),this.setRootPath(),this.children={}}return o(s,[{key:"shutdown",value:function(){this.stopUpdate().clear().destroyEventEmitter()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){if(void 0===e){var t=this.parent?this.parent.rootPath:"";e="".concat(t,"/").concat(this.key)}var r;for(var i in this.rootPath=e,this.children)(r=this.children[i])instanceof s&&r.setRootPath();return this}},{key:"load",value:function(){var r=this;return this.rootRef.once("value").then(function(e){var t=e.val()||{};return r.table.setValue(t),Promise.resolve(t)})}},{key:"setData",value:function(e,t){if(void 0===e)this.clear();else if(void 0===t){var r=e;for(e in this.children)r.hasOwnProperty(e)||this.removeChild(e);for(e in r)this.setChildData(e,r[e])}else this.setChildData(e,t);return this}},{key:"clear",value:function(){for(var e in this.table.removeKey(this.fullKeyPath),this.children)this.removeChild(e);return this}},{key:"setChildData",value:function(e,t){var r=te(this.fullKeyPath,e);if(this.table.setValue(r,t),this.children.hasOwnProperty(e))this.children[e].setData(t);else if(this.childClass){var i=new this.childClass({parent:this,key:e,type:this.type,eventEmitter:this.getEventEmitter(),eventNames:this.eventNames,table:this.table});i.startUpdate(),this.children[e]=i}return this}},{key:"removeChild",value:function(e){return this.children.hasOwnProperty(e)&&(this.children[e].destroy(),delete this.children[e]),this}},{key:"startUpdate",value:function(){}},{key:"stopUpdate",value:function(){}},{key:"rootRef",get:function(){return this.database.ref(this.rootPath)}},{key:"childClass",get:function(){}}]),s}(),te=function(e,t){return null==e||""===e?t:null==t||""===t?e:"".concat(e,".").concat(t)};Object.assign(ee.prototype,k);var re=function(){s(t,ee);var e=c(t);function t(){return n(this,t),e.apply(this,arguments)}return o(t,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addCol,this),this.rootRef.on("child_removed",this.removeCol,this),this.rootRef.on("child_changed",this.changeColValue,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addCol,this),this.rootRef.off("child_removed",this.removeCol,this),this.rootRef.off("child_changed",this.changeColValue,this),this}},{key:"addCol",value:function(e){var t=e.key,r=e.val();switch(this.setData(t,r),this.type){case 1:this.emit(this.eventNames.addkey0,t,r);break;case 2:this.emit(this.eventNames.addkey1,this.key,t,r);break;default:this.emit(this.eventNames.addkey2,this.pageKey,this.key,t,r)}this.emit(this.eventNames.update,this.table.data)}},{key:"removeCol",value:function(e){var t=e.key;switch(this.removeChild(t),this.type){case 1:this.emit(this.eventNames.removekey0,t);break;case 2:this.emit(this.eventNames.removekey1,this.key,t);break;default:this.emit(this.eventNames.removekey2,this.pageKey,this.key,t)}this.emit(this.eventNames.update,this.table.data)}},{key:"changeColValue",value:function(e){var t=e.key,r=e.val();switch(this.setData(t,r),this.type){case 1:this.emit(this.eventNames.changekey0,t,r);break;case 2:this.emit(this.eventNames.changekey1,this.key,t,r);break;default:this.emit(this.eventNames.changekey2,this.pageKey,this.key,t,r)}this.emit(this.eventNames.update,this.table.data)}},{key:"pageKey",get:function(){return this.parent.key}}]),t}(),ie=function(){s(t,ee);var e=c(t);function t(){return n(this,t),e.apply(this,arguments)}return o(t,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addRow,this),this.rootRef.on("child_removed",this.removeRow,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addRow,this),this.rootRef.off("child_removed",this.removeRow,this),this}},{key:"addRow",value:function(e){var t=e.key,r=e.val();switch(this.setData(t,r),this.type){case 2:this.emit(this.eventNames.addkey0,this.key,t,r);break;default:this.emit(this.eventNames.addkey1,this.key,t,r)}}},{key:"removeRow",value:function(e){var t=e.key;switch(this.removeChild(t),this.type){case 2:this.emit(this.eventNames.removekey0,t);break;default:this.emit(this.eventNames.removekey1,this.key,t)}}},{key:"childClass",get:function(){return re}},{key:"pageKey",get:function(){return this.parent.key}}]),t}(),se=function(){s(r,ee);var t=c(r);function r(e){return n(this,r),t.call(this,e)}return o(r,[{key:"startUpdate",value:function(){return this.rootRef.on("child_added",this.addPage,this),this.rootRef.on("child_removed",this.removePage,this),this}},{key:"stopUpdate",value:function(){return this.rootRef.off("child_added",this.addPage,this),this.rootRef.off("child_removed",this.removePage,this),this}},{key:"addPage",value:function(e){var t=e.key,r=e.val();this.setData(t,r),this.emit(this.eventNames.addkey0,t,r)}},{key:"removePage",value:function(e){var t=e.key;this.removeChild(t),this.emit(this.eventNames.removekey0,t)}},{key:"childClass",get:function(){return ie}}]),r}(),ne=function(){function i(e){n(this,i);var t=R(e,"eventEmitter",void 0),r=R(e,"EventEmitterClass",void 0);this.setEventEmitter(t,r),this.eventNames=R(e,"eventNames",fe),this.database=firebase.database(),this.table=new Z,this.setTableType(R(e,"type",3)),this.setRootPath(R(e,"root","")),this.initialFlag=!1}return o(i,[{key:"shutdown",value:function(){this.updater.destroy(),this.destroyEventEmitter().stopUpdate()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.updater.setRootPath(e),this}},{key:"setTableType",value:function(e){"string"==typeof e&&(e=le[e]),this.tableType=e;var t=oe[e];return this.updater=new t({type:e,eventEmitter:this.getEventEmitter(),eventNames:this.eventNames,table:this.table}),this}},{key:"getRootRef",value:function(){return this.database.ref(this.rootPath)}},{key:"getRef",value:function(e,t,r){var i=this.getRootRef();return i=e?i.child(e):i,i=t?i.child(t):i,i=r?i.child(r):i}},{key:"startUpdate",value:function(){return function(){var t=this;return this.initialFlag=!1,this.updater.clear().load().then(function(e){return t.initialFlag=!0,t.emit(t.eventNames.init,e),Promise.resolve(e)})}.call(this),this.updater.startUpdate(),this}},{key:"stopUpdate",value:function(){return this.updater.stopUpdate(),this}},{key:"clear",value:function(){return this.updater.clear(),this}},{key:"getData",value:function(){return this.table.getValue(arguments)}},{key:"cloneData",value:function(){return this.table.cloneValue(arguments)}}]),i}(),oe={1:re,2:ie,3:se},ae={setData:function(e){var t,r,i,s;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);t=n[0],r=n[1],i=n[2],s=n[3];break;case 3:var o=Array.prototype.slice.call(arguments);t=o[0],r=o[1],s=o[2];break;case 2:var a=Array.prototype.slice.call(arguments);t=a[0],s=a[1];break;default:s=e}return this.getRef(t,r,i).set(s)},removeData:function(e){var t,r,i;switch(arguments.length){case 3:var s=Array.prototype.slice.call(arguments);t=s[0],r=s[1],i=s[2];break;case 2:var n=Array.prototype.slice.call(arguments);t=n[0],r=n[1];break;default:t=e}return this.getRef(t,r,i).remove()},incValue:function(e){var t,r,i,s;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);t=n[0],r=n[1],i=n[2],s=n[3];break;case 3:var o=Array.prototype.slice.call(arguments);t=o[0],r=o[1],s=o[2];break;case 2:var a=Array.prototype.slice.call(arguments);t=a[0],s=a[1];break;default:s=e}return this.getRef(t,r,i).transaction(function(e){return null===e&&(e=0),e+s})},transaction:function(e){var t,r,i,s;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);t=n[0],r=n[1],i=n[2],s=n[3];break;case 3:var o=Array.prototype.slice.call(arguments);t=o[0],r=o[1],s=o[2];break;case 2:var a=Array.prototype.slice.call(arguments);t=a[0],s=a[1];break;default:s=e}return this.getRef(t,r,i).transaction(s)},updateData:function(e){return this.getRef().update(e)},removeDataOnDisconnect:function(e){var t,r,i;switch(arguments.length){case 3:var s=Array.prototype.slice.call(arguments);t=s[0],r=s[1],i=s[2];break;case 2:var n=Array.prototype.slice.call(arguments);t=n[0],r=n[1];break;case 1:t=e}return this.getRef(t,r,i).onDisconnect().remove()},setDataOnDisconnect:function(e){var t,r,i,s;switch(arguments.length){case 4:var n=Array.prototype.slice.call(arguments);t=n[0],r=n[1],i=n[2],s=n[3];break;case 3:var o=Array.prototype.slice.call(arguments);t=o[0],r=o[1],s=o[2];break;case 2:var a=Array.prototype.slice.call(arguments);t=a[0],s=a[1];break;default:s=e}return this.getRef(t,r,i).onDisconnect().set(s)}};Object.assign(ne.prototype,k,ae);function ue(e,t){return void 0===t&&(t=""),"".concat(e,"|").concat(t)}function he(e){this.roomID=e.roomID,this.roomName=e.roomName,this.roomType=e.roomType,this.emit("room.join",e)}function ce(e,t,r){void 0===r&&(r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789");for(var i=void 0===t?e:ge(e,t),s="",n=0;n<i;n++)s+=pe(r);return s}var le={"1d":1,"2d":2,"3d":3},fe={init:"init",update:"update",addkey0:"addkey0",removekey0:"removekey0",changekey0:"changekey0",addkey1:"addkey1",removekey1:"removekey1",changekey1:"changekey1",addkey2:"addkey2",removekey2:"removekey2",changekey2:"changekey2"},de=function(e){var t=e.key,r=new ne({eventEmitter:this.getEventEmitter(),root:this.getItemTablePath(this.roomID,t),type:R(e,"type",1),eventNames:{init:"tables.".concat(t,".init"),update:"tables.".concat(t,".update"),addkey0:"tables.".concat(t,".addkey0"),removekey0:"tables.".concat(t,".removekey0"),changekey0:"tables.".concat(t,".changekey0"),addkey1:"tables.".concat(t,".addkey1"),removekey1:"tables.".concat(t,".removekey1"),changekey1:"tables.".concat(t,".changekey1"),addkey2:"tables.".concat(t,".addkey2"),removekey2:"tables.".concat(t,".removekey2"),changekey2:"tables.".concat(t,".changekey2")}});return this.on("room.join",function(){r.startUpdate()}).on("room.leave",function(){r.clear().stopUpdate()}),r},ve=function(e){return this.getRoomAliveRef(e).transaction(function(e){return null===e||void 0})},me=function(i){var s=(i=m(ye,i)).roomID,e=i.roomName,t=i.roomType,r=i.door,n=i.join,o=i.filterData,a=this.getRoomRef(s),u=this.getRoomFilterRef(s),h=this.getRoomDataRef(s);this.isRemoveRoomWhenLeft=!i.presisted,this.isRemoveRoomWhenLeft&&(a.onDisconnect().remove(),u.onDisconnect().remove(),h.onDisconnect().remove());var c=ue(r,t),l={},f={filter:c,name:e};o&&(f.data=o),l["room-filters/".concat(s)]=f;var d={name:e,filter:c,maxUsers:i.maxUsers,moderators:{}};d.moderators[this.userID]=this.userName,l["room-data/".concat(s)]=d;var v=this;return new Promise(function(e,t){if(n){var r=v.userList.setRootPath(v.getUserListPath(s)).setMaxUsers(0).join();return v.userList.setMaxUsers(i.maxUsers),r.then(e,t)}return e()}).then(function(){return v.getRootRef().update(l)}).then(function(){return v.isRoomCreator=!0,n&&he.call(v,i),Promise.resolve(i)})},ye={roomID:"",roomName:"",roomType:"",maxUsers:0,presisted:!1,door:"open",join:!0,filterData:void 0},ge=function(e,t){return Math.floor(Math.random()*(t-e+1)+e)},pe=function(e,t,r){void 0===t&&(t=0),void 0===r&&(r=e.length);var i=t+Math.floor(Math.random()*r);return void 0===e[i]?null:e[i]},Ie=function e(t,r,i,s){if(s.roomID=ce(t,t,r),i<=0)return Promise.reject(s);i--;var n=this;return this.createRoom(s).catch(function(){return e.call(n,t,r,i,s)})},De=function(t){if(void 0===R(t,"roomID",void 0))return Promise.reject();this.isRemoveRoomWhenLeft=!1;var r=this;return ke.call(r,t).then(function(e){return r.userList.setRootPath(r.getUserListPath(t.roomID)).setMaxUsers(e.maxUsers).join()}).then(function(){return he.call(r,t),Promise.resolve(t)})},ke=function(r){var i=this;return this.getRoomDataRef(r.roomID).once("value").then(function(e){var t=e.val();return null===t?Promise.reject():(r.roomName=t.name,r.roomType=t.filter.split("|")[1],i.isRoomOpened(t)?Promise.resolve(t):Promise.reject())})},Re=function(e){for(var t=e.length-1;0<t;t--){var r=Math.floor(Math.random()*(t+1)),i=e[t];e[t]=e[r],e[r]=i}return e},be=function e(t,r,i){if(i===r.length)return Promise.reject();t.roomID=r[i].roomID,i++;var s=this;return this.joinRoom(t).catch(function(){return e.call(s,t,r,i)})},Pe={getRootRef:function(e){var t=this.database.ref(this.rootPath);return e&&(t=t.child(e)),t},getRoomRef:function(e,t){var r=this.getRootRef("rooms");return void 0!==e&&(r=r.child(e),void 0!==t&&(r=r.child(t))),r},getRoomAliveRef:function(e){return this.getRoomRef(e,"alive")},getUserListRef:function(e){return this.getRoomRef(e,"users")},getRoomFilterRef:function(e){var t=this.getRootRef("room-filters");return void 0!==e&&(t=t.child(e)),t},getRoomDataRef:function(e){var t=this.getRootRef("room-data");return void 0!==e&&(t=t.child(e)),t},getUserDataRef:function(e){var t=this.getRootRef("user-data");return void 0!==e&&(t=t.child(e)),t},getRoomDataPath:function(e,t){var r="".concat(this.rootPath,"/rooms/").concat(e);return t&&(r+="/".concat(t)),r},getUserListPath:function(e){return this.getRoomDataPath(e,"users")},getItemTablePath:function(e,t){return"".concat(this.getRoomDataPath(e,"tables"),"/").concat(t)},getRoomListQuery:function(e,t){void 0===t&&(t="open");var r=this.getRoomFilterRef();return r=r.orderByChild("filter"),r=void 0===e?r.startAt(t).endAt("".concat(t,"~")):r.equalTo(ue(t,e))}},Ee={createRoom:function(e){void 0===e&&(e={}),null==e.roomID&&(e.roomID=this.getRoomRef().push().key);var t=this;return ve.call(t,e.roomID).then(function(){return me.call(t,e)})},createRandomRoom:function(e){void 0===e&&(e={});var t=R(e,"digits",10),r=R(e,"candidates","0123456789"),i=R(e,"retry",1e3);return Ie.call(this,t,r,i,e)},joinRoom:function(e){var t=R(e,"leftThenJoin",!0),r=this;return t?this.leaveRoom().then(function(){return De.call(r,e)}):De.call(r,e)},joinRandomRoom:function(t){void 0===t&&(t={});var e=R(t,"roomType",""),r=R(t,"door","open"),i=this;return this.getRoomList(e,r).then(function(e){return Re(e),be.call(i,t,e,0)})},leaveRoom:function(){if(!this.isInRoom())return Promise.resolve();if(this.leftRoomFlag=!0,this.isRemoveRoomWhenLeft)return this.removeRoom();var e=this.getRoomInfo();return this.userList.leave().then(function(){return Promise.resolve(e)})},removeRoom:function(e){if(void 0===e&&(e=this.roomID),void 0===e)return Promise.resolve();var t={};t["room-filter/".concat(e)]=null,t["room-data/".concat(e)]=null,t["rooms/".concat(e)]=null;var r=this.getRoomInfo();return this.getRootRef().update(t).then(function(){return Promise.resolve(r)})},kickUser:function(e){return this.userList.contains(e)?e===this.userID?this.leaveRoom():this.userList.leave(e):Promise.resolve()},isRoomOpened:function(e){if(null==e)return!1;if("closed"===e.filter.split("|")[0])return!1;var t=this.userID;if(e.moderators.hasOwnProperty(t))return!0;switch(e.permission){case"black-list":var r=e["black-list"];return!(r&&r.hasOwnProperty(t));case"white-list":var i=e["white-list"];return i&&i.hasOwnProperty(t);default:return!0}},changeRoomState:function(i,s){1===arguments.length&&(s=i,i=void 0),void 0===i&&(i=this.roomID);var n=this;return this.hasRoom(i).then(function(e){if(!e)return Promise.resolve();var t=ue(s,n.roomType),r={};return r["room-filters/".concat(i,"/filter")]=t,r["room-data/".concat(i,"/filter")]=t,n.getRootRef().update(r)})},changeFilterData:function(t,r){1===arguments.length&&(r=t,t=void 0),void 0===t&&(t=this.roomID);var i=this;return this.hasRoom(t).then(function(e){return e?i.getRoomFilterRef(t).child("data").update(r):Promise.resolve()})},changeUserName:function(e){return this.userList.changeUserName(e)},changeRoomName:function(r,i){1===arguments.length&&(i=r,r=void 0),void 0===r&&(r=this.roomID);var s=this;return this.hasRoom(r).then(function(e){if(!e)return Promise.resolve();var t={};return t["room-filters/".concat(r,"/name")]=i,t["room-data/".concat(r,"/name")]=i,s.getRootRef().update(t)})},openRoom:function(e){return this.setRoomState(e,"open")},closeRoom:function(e){return this.setRoomState(e,"closed")},getUserList:function(r){if(void 0===r)return this.userList.getUsers();var i=this;return new Promise(function(t,e){new q({itemIDKey:"joinAt",mode:"once"}).once("update",function(e){t(e)}).startUpdate(i.getUserListRef(r))})},getRoomList:function(r,i){var s=this;return new Promise(function(t,e){s.roomList.once("roomlist.update",function(e){t(e)}).startUpdate(s.getRoomListQuery(r,i))})},hasRoom:function(e){return e===this.roomID?Promise.resolve(!0):this.getRoomDataRef(e).once("value").then(function(e){var t=null!==e.val();return Promise.resolve(t)})}};Object.assign(Ee,Pe);var we=function(){function i(e){n(this,i);var t=R(e,"eventEmitter",void 0),r=R(e,"EventEmitterClass",void 0);this.setEventEmitter(t,r),this.database=firebase.database(),this.rootPath=R(e,"root",""),this.userInfo={userID:"",userName:""},this.setUser(R(e,"userID",""),R(e,"userName","")),this.isRoomCreator=!1,this.roomID=void 0,this.roomName=void 0,this.roomType=void 0,this.doorState=void 0,this.leftRoomFlag=!1,this.isRemoveRoomWhenLeft=void 0,this.userList=function(){var e=new J({eventEmitter:this.getEventEmitter(),eventNames:{join:"userlist.join",leave:"userlist.leave",update:"userlist.update",change:"userlist.change",init:"userlist.init",changename:"userlist.changename"},userID:this.userInfo});return e.on("userlist.leave",function(e){e.userID===this.userID&&X.call(this)},this),this.on("room.join",function(){e.startUpdate()}).on("room.leave",function(){e.stopUpdate().clear()}),e}.call(this,e),this.roomList=function(){return new q({eventEmitter:this.getEventEmitter(),root:this.getRoomFilterRef(),itemIDKey:"roomID",eventNames:{update:"roomlist.update",add:"roomlist.add",remove:"roomlist.remove",change:"roomlist.change"},mode:"once"})}.call(this,e),this.broadcast=function(e){var t=R(e,"broadcast",!0);if(!t)return null;var r=new x({eventEmitter:this.getEventEmitter(),eventNames:{receive:"broadcast.receive"},receiverID:"boradcast",senderID:this.userInfo,history:R(t,"history",!1)});return this.on("room.join",function(e){r.setRootPath(this.getRoomDataPath(e.roomID)).startReceiving()},this).on("room.leave",function(){r.stopReceiving()},this).on("userlist.changename",function(e,t){r.changeUserName(e,t)},this),r}.call(this,e),this.tables=function(e){var t,r=R(e,"tables",void 0);if(void 0===r)return{};for(var i={},s=0,n=r.length;s<n;s++)i[(t=r[s]).key]=de.call(this,t);return i}.call(this,e)}return o(i,[{key:"shutdown",value:function(){var e=this;this.destroyEventEmitter().leaveRoom().then(function(){e.userList.destroy(),e.userList=void 0,e.roomList.destroy(),e.roomList=void 0,e.broadcast.destroy(),e.broadcast=void 0})}},{key:"destroy",value:function(){this.shutdown()}},{key:"getRoomInfo",value:function(e,t){return void 0===e&&(e=this.roomID),void 0===t&&(t=this.roomName),{roomID:e,roomName:t}}},{key:"setUser",value:function(e,t){return b(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"isInRoom",value:function(e){return void 0===e?void 0!==this.roomID:this.roomID===e}},{key:"isFull",value:function(){return this.userList.isFull()}},{key:"isFirstUser",value:function(e){return this.userList.isFirstUser(e)}},{key:"getUsers",value:function(){return this.userList.getUsers()}},{key:"getTable",value:function(e){return this.tables[e]}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"maxUsers",get:function(){return this.userList.maxUsers}}]),i}();Object.assign(we.prototype,k,Ee),D.register("room",function(e){return new we(e)}),U(window,"RexPlugins.Fire.Room",we);var xe=function(){this.emit("room.leave");var e=this;setTimeout(function(){e.leftRoomFlag=!1},0)},Ne=function(e){var t=e.key,r=new ne({eventEmitter:this.getEventEmitter(),root:this.getItemTablePath(t),type:R(e,"type",1),eventNames:{init:"tables.".concat(t,".init"),update:"tables.".concat(t,".update"),addkey0:"tables.".concat(t,".addkey0"),removekey0:"tables.".concat(t,".removekey0"),changekey0:"tables.".concat(t,".changekey0"),addkey1:"tables.".concat(t,".addkey1"),removekey1:"tables.".concat(t,".removekey1"),changekey1:"tables.".concat(t,".changekey1"),addkey2:"tables.".concat(t,".addkey2"),removekey2:"tables.".concat(t,".removekey2"),changekey2:"tables.".concat(t,".changekey2")}});return this.on("room.join",function(){r.startUpdate()}).on("room.leave",function(){r.clear().stopUpdate()}),r},Fe={joinRoom:function(){var e=this;return this.userList.join().then(function(){return e.emit("room.join"),Promise.resolve()})},leaveRoom:function(){return this.isInRoom()?(this.leftRoomFlag=!0,this.userList.leave()):Promise.resolve()},kickUser:function(e){return this.userList.contains(e)?e===this.userID?this.leaveRoom():this.userList.leave(e):Promise.resolve()},changeUserName:function(e){return this.userList.changeUserName(e)},getUserList:function(){return this.userList.getUsers()}};Object.assign(Fe,{getRoomRef:function(e){var t=this.database.ref(this.rootPath);return e&&(t=t.child(e)),t},getUserListRef:function(){return this.getRoomRef("users")},getRoomDataPath:function(e){var t=this.rootPath;return e&&(t+="/".concat(e)),t},getUserListPath:function(){return this.getRoomDataPath("users")},getItemTablePath:function(e){return"".concat(this.getRoomDataPath("tables"),"/").concat(e)}});var Ue=function(){function i(e){n(this,i);var t=R(e,"eventEmitter",void 0),r=R(e,"EventEmitterClass",void 0);this.setEventEmitter(t,r),this.database=firebase.database(),this.rootPath=R(e,"root",""),this.userInfo={userID:"",userName:""},this.setUser(R(e,"userID",""),R(e,"userName","")),this.leftRoomFlag=!1,this.userList=function(e){var t=new J({eventEmitter:this.getEventEmitter(),eventNames:{join:"userlist.join",leave:"userlist.leave",update:"userlist.update",change:"userlist.change",init:"userlist.init",changename:"userlist.changename"},root:this.getUserListPath(),userID:this.userInfo,maxUsers:R(e,"maxUsers",0)});return t.on("userlist.leave",function(e){e.userID===this.userID&&xe.call(this)},this),this.on("room.join",function(){t.startUpdate()}).on("room.leave",function(){t.stopUpdate().clear()}),t}.call(this,e),this.broadcast=function(e){var t=R(e,"broadcast",!0);if(!t)return null;var r=new x({eventEmitter:this.getEventEmitter(),eventNames:{receive:"broadcast.receive"},root:this.rootPath,receiverID:"broadcast",senderID:this.userInfo,history:R(t,"history",!1)});return this.on("room.join",function(){r.startReceiving()}).on("room.leave",function(){r.stopReceiving()}).on("userlist.changename",function(e,t){r.changeUserName(e,t)},this),r}.call(this,e),this.tables=function(e){var t,r=R(e,"tables",void 0);if(void 0===r)return{};for(var i={},s=0,n=r.length;s<n;s++)i[(t=r[s]).key]=Ne.call(this,t);return i}.call(this,e)}return o(i,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"setUser",value:function(e,t){return b(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"isInRoom",value:function(){return this.userList.isInList}},{key:"isFull",value:function(){return this.userList.isFull()}},{key:"isFirstUser",value:function(e){return this.userList.isFirstUser(e)}},{key:"getUsers",value:function(){return this.userList.getUsers()}},{key:"getTable",value:function(e){return this.tables[e]}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"maxUsers",get:function(){return this.userList.maxUsers}}]),i}();Object.assign(Ue.prototype,k,Fe),D.register("singleRoom",function(e){return new Ue(e)}),U(window,"RexPlugins.Fire.SingleRoom",Ue),D.register("itemTable",function(e){return new ne(e)}),U(window,"RexPlugins.Fire.ItemTable",ne);function Le(e){return void 0===e.totalLines&&(e.totalLines=1/0),void 0===e.linesPerPage&&(e.linesPerPage=1e3),e.remainderLines=e.totalLines,je(e)}function Ce(e,t,s,r,i){void 0===t&&(t=1/0),void 0===s&&(s=0);var n=[],o=0;return Le({query:e,totalLines:s+t,startDocRef:r,startMode:i,forEachPageCallback:function(e){var t,r=e.size,i=s-o;i<=0?t=e.docs:i<r&&(t=e.docs.slice(i,r)),t&&n.push.apply(n,l(t)),o+=r},resolveCallback:function(){return n}})}var je=function i(s){var e=s.query;s.startDocRef&&(e=e[s.startMode](s.startDocRef));var n=Math.min(s.remainderLines,s.linesPerPage);return s.remainderLines-=n,e.limit(n).get().then(function(e){var t,r=0===s.remainderLines||e.size<n;return s.forEachPageCallback&&(r|=!!s.forEachPageCallback(e)),r?(s.resolveCallback&&(t=s.resolveCallback()),Promise.resolve(t)):(s.startDocRef=e.docs[e.size-1],s.startMode="startAfter",i(s))})},_e=function(){var r=this;return Ce(this.nextQuery,this.itemCount,0,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return r.cacheItems=e,r.pageIndex=0,r.startItemIndex=0,r.endItemIndex=r.startItemIndex+t-1,r.isFullPage=t===r.itemCount,r.prevPageEndDocRef=void 0,r.currPageStartDocRef=e[0],r.currPageEndDocRef=e[t-1],Promise.resolve(r.cacheItems)})},Qe=function(){var r=this;return Ce(this.nextQuery,this.itemCount,0,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return r.cacheItems=e,r.pageIndex=0,r.startItemIndex=0,r.endItemIndex=r.startItemIndex+t-1,r.isFullPage=t===r.itemCount,Promise.resolve(r.cacheItems)})},Ae=function(){var r=this;return Ce(this.nextQuery,this.itemCount,0,this.currPageEndDocRef,"startAfter").then(function(e){var t=e.length;return r.cacheItems=e,r.pageIndex+=1,r.startItemIndex=r.endItemIndex+1,r.endItemIndex=r.startItemIndex+t-1,r.isFullPage=t===r.itemCount,r.prevPageEndDocRef=r.currPageEndDocRef,r.currPageStartDocRef=e[0],r.currPageEndDocRef=e[t-1],Promise.resolve(r.cacheItems)})},Te=function(){var e=(this.pageIndex+1)*this.itemCount,r=this;return Ce(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return r.cacheItems=e,r.pageIndex+=1,r.startItemIndex=r.endItemIndex+1,r.endItemIndex=r.startItemIndex+t-1,r.isFullPage=t===r.itemCount,Promise.resolve(r.cacheItems)})},Oe=function(){var r=this;return Ce(this.prevQuery,this.itemCount+1,0,this.currPageStartDocRef,"startAfter").then(function(e){var t=e.length-1;return r.cacheItems=e,r.cacheItems.pop(),r.cacheItems.reverse(),--r.pageIndex,r.endItemIndex=r.startItemIndex-1,r.startItemIndex=r.endItemIndex-t+1,r.isFullPage=t===r.itemCount,r.prevPageEndDocRef=e[t],r.currPageStartDocRef=e[t-1],r.currPageEndDocRef=e[0],Promise.resolve(r.cacheItems)})},Me=function(){var e=(this.pageIndex-1)*this.itemCount,r=this;return Ce(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return r.cacheItems=e,--r.pageIndex,r.endItemIndex=r.startItemIndex-1,r.startItemIndex=r.endItemIndex-t+1,r.isFullPage=t===r.itemCount,Promise.resolve(r.cacheItems)})},Se=function(){var r=this;return Ce(this.nextQuery,this.itemCount,0,this.prevPageEndDocRef,"startAfter").then(function(e){var t=e.length;return r.cacheItems=e,r.endItemIndex=r.startItemIndex+t-1,r.isFullPage=t===r.itemCount,r.currPageStartDocRef=e[0],r.currPageEndDocRef=e[t-1],Promise.resolve(r.cacheItems)})},Ke=function(){var e=this.pageIndex*this.itemCount,r=this;return Ce(this.nextQuery,this.itemCount,e,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return r.cacheItems=e,r.endItemIndex=r.startItemIndex+t-1,r.isFullPage=t===r.itemCount,Promise.resolve(r.cacheItems)})},Be=function(){function t(e){n(this,t),this.setItemCount(R(e,"itemCount",100)),this.setQuery(R(e,"query",void 0)),this.setDataMode(R(e,"dataMode",0)),this.setBaselineDoc(R(e,"baselineDoc",void 0),R(e,"baselineMode",void 0)),this.pageIndex=void 0,this.baselineDocRef=void 0,this.baselineMode="startAt",this.startItemIndex=void 0,this.endItemIndex=void 0,this.cacheItems=void 0,this.isFullPage=void 0}return o(t,[{key:"setItemCount",value:function(e){return this.itemCount=e,this}},{key:"setQuery",value:function(e,t){if(b(e)){var r=e;this.nextQuery=r.next,this.prevQuery=r.previous}else this.nextQuery=e,this.prevQuery=t;return this.pageIndex=void 0,this.isFullPage=void 0,this}},{key:"setDataMode",value:function(e){return"string"==typeof e&&(e=ze[e]),this.dataMode=e,this}},{key:"setBaselineDoc",value:function(e,t){return e?(this.baselineDocRef=e.ref,this.baselineMode=t):this.baselineDocRef=void 0,this}}]),t}(),qe={loadFirstPage:function(){return(0===this.dataMode?_e:Qe).call(this)},loadNextPage:function(){return void 0===this.pageIndex?this.loadFirstPage():(0===this.dataMode?Ae:Te).call(this)},loadPreviousPage:function(){return void 0===this.pageIndex||1===this.pageIndex?this.loadFirstPage():(0===this.dataMode?Oe:Me).call(this)},loadCurrentPage:function(){return void 0===this.pageIndex||0===this.pageIndex?this.loadFirstPage():(0===this.dataMode?Se:Ke).call(this)},load:function(r,i){void 0===i&&(i=0);var s=this;return Ce(this.nextQuery,r,i,this.baselineDocRef,this.baselineMode).then(function(e){var t=e.length;return s.cacheItems=e,s.pageIndex=void 0,s.startItemIndex=i,s.endItemIndex=s.startItemIndex+t-1,s.isFullPage=void 0===r||t===r,Promise.resolve(s.cacheItems)})}};Object.assign(Be.prototype,qe);var ze={static:0,dynamic:1};D.register("pageLoader",function(e){return new Be(e)}),U(window,"RexPlugins.Fire.PageLoader",Be);function He(e){var t=e.data();return t.headerDocID=e.id,t}var Ve=function(){function t(e){n(this,t),this.database=firebase.firestore(),this.setRootPath(R(e,"root","")),this.cacheHeaders={},this.userInfo={userID:""},this.setOwner(R(e,"userID",""))}return o(t,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setOwner",value:function(e){var t=this.userID;return b(e)?this.userInfo=e:this.userID=e,t!==this.userID&&this.clearCache(),this}},{key:"clearCache",value:function(){return d(this.cacheHeaders),this}},{key:"getFileQuery",value:function(e,t,r){var i=this.rootRef;return i=e?i.where("userID","==",e):i,i=t?i.where("fileID","==",t):i,i=r?i.where("type","==",r):i}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}}]),t}(),We={save:function(t,s,n,e){"boolean"==typeof n&&(e=n,n=void 0),void 0===e&&(e=!1);var r=this.userID;void 0===s&&(s={}),s.userID=r,s.fileID=t,s.type="header",n&&(n.userID=r,n.fileID=t,n.type="content");var o=e?"update":"set",a=this;return function(i){var e=this.userID,t=this.cacheHeaders[i];if(t&&t.userID===e)return Promise.resolve(t);var s=this;return this.getFileQuery(e,i,"header").limit(1).get().then(function(e){var t=void 0;if(0<e.size){var r=e.docs[0];t=He(r),s.cacheHeaders[i]=t}return Promise.resolve(t)})}.call(this,t).then(function(e){var t,r;e?(t=a.rootRef.doc(e.headerDocID),n&&(r=e.contentDocID?a.rootRef.doc(e.contentDocID):a.rootRef.doc())):(t=a.rootRef.doc(),n&&(r=a.rootRef.doc())),s.hasOwnProperty("headerDocID")&&delete s.headerDocID,r&&(s.contentDocID=r.id);var i=a.database.batch();return i[o](t,s),n&&i[o](r,n),i.commit()}).then(function(){return Promise.resolve({userID:r,fileID:t})}).catch(function(e){return Promise.reject({error:e,userID:r,fileID:t})})},load:function(i){var s=this.userID;return this.getFileQuery(s,i).get().then(function(e){var t,r;return e.forEach(function(e){switch(docData.type){case"header":t=He(e);break;case"content":r=e.data()}}),Promise.resolve({userID:s,fileID:i,header:t,content:r})}).catch(function(){return Promise.reject({error:error,userID:s,fileID:i})})},loadHeaders:function(){var r=this.userID,i=this;return this.getFileQuery(r,void 0,"header").get().then(function(e){var t;return d(i.cacheHeaders),e.forEach(function(e){t=He(e),i.cacheHeaders[t.fileID]=t}),Promise.resolve({userID:r,headers:i.cacheHeaders})}).catch(function(){return Promise.reject({error:error,userID:r})})},delete:function(r){var i=this.userID,s=this;return LoadHeader.call(this,r).then(function(e){if(!e)return Promise.resolve({userID:i,fileID:r});var t=s.database.batch();return t.delete(s.rootRef.doc(e.headerDocID)),e.contentDocID&&t.delete(s.rootRef.doc(e.contentDocID)),t.commit()}).then(function(){return s.cacheHeaders.hasOwnProperty(r)&&delete s.cacheHeaders[r],Promise.resolve({userID:i,fileID:r})}).catch(function(e){return Promise.reject({error:e,userID:i,fileID:r})})},clear:function(){var t=this.userID,i=this;return this.getFileQuery(t,void 0,"header").get().then(function(e){var t,r=i.database.batch();return e.forEach(function(e){t=DocToHeader(e),r.delete(i.rootRef.doc(t.headerDocID)),t.contentDocID&&r.delete(i.rootRef.doc(t.contentDocID))}),r.commit()}).then(function(){return i.clearCache(),Promise.resolve({userID:t})}).catch(function(e){return Promise.reject({error:e,userID:t})})}};Object.assign(Ve.prototype,We),D.register("files",function(e){return new Ve(e)}),U(window,"RexPlugins.Fire.Files",Ve);function Ye(i,s){var e=this;return this.database.runTransaction(function(t){var r=e.getAliasRef(s);return t.get(r).then(function(e){return e.exists?Promise.reject({id:i,alias:s}):(t.set(r,{id:i}),Promise.resolve({id:i,alias:s}))})})}function Je(e,t,r,i){var s=ce(t,t,r);if(i<=0)return Promise.reject({id:e,alias:s});i--;var n=this;return Ye.call(n,e,s).catch(function(){setTimeout(function(){return Je.call(n,e,t,r,i)},0)})}var Ge=function(){function t(e){n(this,t),this.database=firebase.firestore(),this.setRootPath(R(e,"root",""))}return o(t,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"getAliasRef",value:function(e){return this.rootRef.doc(e)}}]),t}(),Xe={add:function(t,r){var i=this;return this.getAlias(t).then(function(e){return e.alias?e.alias===r?Promise.resolve({id:t,alias:r}):Promise.reject({id:t,alias:r}):Ye.call(i,t,r)})},addRandom:function(r,e){var i=R(e,"digits",10),s=R(e,"candidates","0123456789"),n=R(e,"retry",1e3),o=this;return this.getAlias(r).then(function(e){if(e.alias){var t=ce(i,i,s);return e.alias===t?Promise.resolve({id:r,alias:t}):Promise.reject({id:r,alias:t})}return Je.call(o,r,i,s,n)})},getId:function(r){return this.getAliasRef(r).get().then(function(e){var t;return e.exists&&(t=e.data().id),Promise.resolve({id:t,alias:r})})},getAlias:function(r){return this.rootRef.where("id","==",r).limit(1).get().then(function(e){var t;0<e.size&&(t=e.docs[0].id);return Promise.resolve({id:r,alias:t})})},getRandomAlias:function(t,e){var r=R(e,"digits",10),i=R(e,"candidates","0123456789"),s=R(e,"retry",1e3),n=this;return this.getAlias(t).then(function(e){return e.alias?Promise.resolve(e):Je.call(n,t,r,i,s)})},remove:function(e){var t=this;return this.getAlias(e).then(function(e){return t.getAliasRef(e).delete()})}};Object.assign(Ge.prototype,Xe),D.register("idAlias",function(e){return new Ge(e)}),U(window,"RexPlugins.Fire.IdAlias",Ge);function Ze(e){var t=e?new Date(e):new Date,r=t.getFullYear(),i=t.getMonth()+1,s=t.getDate(),n=new Date(t.getFullYear(),0,1),o=Math.ceil(((t-n)/864e5+n.getDay()+1)/7);return{d:"".concat(r,"-").concat(i,"-").concat(s),w:"".concat(r,"-").concat(o),m:"".concat(r,"-").concat(i),y:"".concat(r)}}function $e(e){return Ce(e).then(function(e){if(0===e.length)return Promise.resolve();for(var t,r,i=[],s=0,n=e.length;s<n;s++)void 0===t&&(t=firebase.firestore().batch(),r=0),t.delete(e[s].ref),500<=++r&&(i.push(t.commit()),t=void 0);return t&&i.push(t.commit()),Promise.all(i)})}var et={d:"tagD",w:"tagW",m:"tagM",y:"tagY"},tt={d:"scoreD",w:"scoreW",m:"scoreM",y:"scoreY"},rt={loadFirstPage:function(){this.resetPageQuery();var t=this;return this.page.loadFirstPage().then(function(e){return Promise.resolve(it.call(t,e))})},loadNextPage:function(){this.resetPageQuery();var t=this;return this.page.loadNextPage().then(function(e){return Promise.resolve(it.call(t,e))})},loadPreviousPage:function(){this.resetPageQuery();var t=this;return this.page.loadPreviousPage().then(function(e){return Promise.resolve(it.call(t,e))})},loadCurrentPage:function(){this.resetPageQuery();var t=this;return this.page.loadCurrentPage().then(function(e){return Promise.resolve(it.call(t,e))})},load:function(e,t){this.resetPageQuery();var r=this;return this.page.load(e,t).then(function(e){return Promise.resolve(it.call(r,e))})},resetPageQuery:function(){return this.resetQueryFlag&&(this.resetQueryFlag=!1,this.page.setQuery(this.getPageQuery())),this}},it=function(e){for(var t,r=[],i=tt[this.timeFilterType[0]],s=0,n=e.length;s<n;s++){if(t=e[s].data(),!1!==this.timeFilters)for(var o in t.score=t[i],this.timeFilters)delete t[et[o]],delete t[tt[o]];r.push(t)}return r},st={deleteUser:function(e){void 0===e&&(e=this.userID);var t=this.getRecordQuery(void 0,void 0,e,void 0);return $e(t)},deleteBoard:function(e,t){void 0===e&&(e=this.boardID),void 0===t&&(t=this.tag);var r=this.getRecordQuery(e,t,void 0,void 0);return $e(r)}},nt={getRecordQuery:function(e,t,r,i){var s=this.rootRef;return s=void 0!==e?s.where("boardID","==",e):s,s=void 0!==t?s.where("tag","==",t):s,s=void 0!==r?s.where("userID","==",r):s,void 0!==i&&(s=s.where(i[0],"==",i[1])),s},getMyRecordQuery:function(e){return void 0===e&&(e=this.userID),this.getRecordQuery(this.boardID,this.tag,e,void 0).limit(1)},getPageQuery:function(){var e,t;if(!1!==this.timeFilters){var r=this.timeFilterType[0];e=[et[r],Ze()[r]],t=tt[r]}else e=void 0,t="score";var i=this.getRecordQuery(this.boardID,this.tag,void 0,e);return{next:i.orderBy(t,"desc"),previous:i.orderBy(t)}}},ot=function(){function t(e){n(this,t),this.database=firebase.firestore(),this.setRootPath(R(e,"root","")),this.userInfo={userID:void 0,userName:void 0},this.setUser(R(e,"userID",""),R(e,"userName",void 0)),this.setBoardID(R(e,"boardID",void 0)),this.setTag(R(e,"tag",void 0)),this.setTimeFilters(R(e,"timeFilters",!1)),this.setTimeFilterType(R(e,"timeFilterType","year")),this.page=new Be({dataMode:"dynamic",itemCount:R(e,"pageItemCount",100)}),this.resetQueryFlag=!0}return o(t,[{key:"shutdown",value:function(){}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.resetQueryFlag|=this.rootPath!==e,this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setUser",value:function(e,t){return b(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setBoardID",value:function(e){return this.resetQueryFlag|=this.boardID!==e,this.boardID=e,this}},{key:"setTag",value:function(e){return this.resetQueryFlag|=this.tag!==e,this.tag=e,this}},{key:"setTimeFilters",value:function(e){return this.timeFilters=!1!==e&&{d:R(e,"day",!0),w:R(e,"week",!0),m:R(e,"month",!0),y:R(e,"year",!0)},this}},{key:"setTimeFilterType",value:function(e){return this.resetQueryFlag|=this.timeFilterType!==e,this.timeFilterType=e,this}},{key:"setPageItemCount",value:function(e){return this.page.setItemCount(e),this}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"pageIndex",get:function(){return this.page.pageIndex}},{key:"isFirstPage",get:function(){return 0===this.page.pageIndex}},{key:"isLastPage",get:function(){return!1===this.page.isFullPage}}]),t}(),at={post:function(e,t,r){var a={userID:this.userID};void 0!==this.boardID&&(a.boardID=this.boardID),this.userName&&(a.userName=this.userName);var i=Ze(r);if(!1!==this.timeFilters)for(var s in this.timeFilters)this.timeFilters[s]&&(a[et[s]]=i[s],a[tt[s]]=e);else a.score=e;this.tag&&(a.tag=this.tag),t&&Object.assign(a,t);i=Ze();var u=this;return this.getMyRecordQuery().get().then(function(e){var t,r;if(0<e.size){var i=e.docs[0];t=i.data(),r=i.id}if(t)if(!1!==u.timeFilters){for(var s in u.timeFilters)if(u.timeFilters[s]){var n=et[s];if(t[n]===a[n]){var o=tt[s];a[o]=Math.max(t[o],a[o])}}}else a.score=Math.max(t.score,a.score);return void 0===r&&(r=u.rootRef.doc().id),u.rootRef.doc(r).set(a)})},getScore:function(e){return this.getMyRecordQuery(e).get().then(function(e){var t;0<e.size&&(t=e.docs[0].data());return Promise.resolve(t)})},getRank:function(t){void 0===t&&(t=this.userID);var n,o,a,e=this.getPageQuery().next;return n=function(e){return e.data().userID===t},o={doc:void 0,index:void 0},a=0,Le({query:e,forEachPageCallback:function(e){for(var t,r=e.docs,i=0,s=r.length;i<s;i++)if(t=r[i],n(t))return o.doc=t,o.index=a+i,!0;a+=e.size},resolveCallback:function(){return o}}).then(function(e){return Promise.resolve({userID:t,rank:e.index})})}};Object.assign(ot.prototype,at,nt,rt,st),D.register("leaderBoard",function(e){return new ot(e)}),U(window,"RexPlugins.Fire.LeaderBoard",ot);var ut={startReceiving:function(){var e=this.getReceiverQuery(this.receiverID).orderBy("timestamp","desc").limit(1),i=this;return this.unsubscribe=e.onSnapshot({includeMetadataChanges:!0},function(e){if(0<e.size){var t=e.docs[0];if(t.metadata.hasPendingWrites)return void(i.skipFirst&&(i.skipFirst=!1));if(i.resetPageQuery(i.receiverID,t),i.skipFirst)i.skipFirst=!1;else{var r=ht(t);i.cacheMessages.push(r),i.emit("receive",r)}}else i.skipFirst&&(i.skipFirst=!1)},function(e){}),this},stopReceiving:function(){return this.unsubscribe&&this.unsubscribe(),this.resetQueryFlag=!0,this.cacheMessages.length=0,this},loadPreviousMessages:function(){this.resetPageQuery(this.receiverID);var n=this;return this.page.loadNextPage().then(function(e){for(var t,r=[],i=0,s=e.length;i<s;i++)r.push(ht(e[i]));return(t=n.cacheMessages).splice.apply(t,[0,0].concat(r)),Promise.resolve(r)})},resetPageQuery:function(e,t){if(!this.resetQueryFlag)return this;this.resetQueryFlag=!1;var r=this.skipFirst?"startAt":"startAfter";return this.page.setBaselineDoc(t,r).setQuery(this.getPageQuery(e)),this}},ht=function(e){var t=e.data();return t.timestamp=1e3*t.timestamp.seconds,t},ct={getReceiverQuery:function(e){void 0===e&&(e=this.receiverID);var t=this.rootRef;return t=void 0!==e?t.where("receiverID","==",e):t},getPageQuery:function(e){var t=this.getReceiverQuery(e);return{next:t.orderBy("timestamp"),previous:t.orderBy("timestamp","desc")}}},lt=function(){function i(e){n(this,i);var t=R(e,"eventEmitter",void 0),r=R(e,"EventEmitterClass",void 0);this.setEventEmitter(t,r),this.database=firebase.firestore(),this.setRootPath(R(e,"root","")),this.userInfo={userID:"",userName:void 0},this.setSender(R(e,"senderID",""),R(e,"senderName","")),this.setReceiver(R(e,"receiverID",void 0)),this.skipFirst=!0,this.unsubscribe=void 0,this.page=new Be,this.setPageItemCount(R(e,"pageItemCount",100)),this.resetQueryFlag=!0,this.cacheMessages=[]}return o(i,[{key:"shutdown",value:function(){this.stopReceiving().destroyEventEmitter()}},{key:"destroy",value:function(){this.shutdown()}},{key:"setRootPath",value:function(e){return this.resetQueryFlag|=this.rootPath!==e,this.rootPath=e,this.rootRef=this.database.collection(e),this}},{key:"setSender",value:function(e,t){return b(e)?this.userInfo=e:(this.userID=e,this.userName=t),this}},{key:"setReceiver",value:function(e){return this.resetQueryFlag|=this.receiverID!==e,this.receiverID=e,this}},{key:"setPageItemCount",value:function(e){return this.page.setItemCount(e),this}},{key:"userID",get:function(){return this.userInfo.userID},set:function(e){this.userInfo.userID=e}},{key:"userName",get:function(){return this.userInfo.userName},set:function(e){this.userInfo.userName=e}},{key:"hasPreviousMessage",get:function(){return!1!==this.page.isFullPage}}]),i}(),ft={send:function(e){var t={senderID:this.userID,message:e,timestamp:firebase.firestore.FieldValue.serverTimestamp()};return void 0!==this.userName&&(t.senderName=this.userName),void 0!==this.receiverID&&(t.receiverID=this.receiverID),this.rootRef.add(t)}};return Object.assign(lt.prototype,k,ft,ut,ct),D.register("messages",function(e){return new lt(e)}),U(window,"RexPlugins.Fire.Messages",lt),function(){function e(){n(this,e),this.add=new D}return o(e,[{key:"initializeApp",value:function(e){return this.add.initializeApp(e),this}},{key:"preload",value:function(e,t){return g(e,t)}}]),e}()});
